# æ™ºç»˜æµ·æŠ¥ - å‰åç«¯äº¤äº’è®¾è®¡

**ç‰ˆæœ¬**: V1.0
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ26æ—¥
**ç›®æ ‡**: ç¡®ä¿å‰åç«¯äº¤äº’é«˜æ•ˆã€å®‰å…¨ã€å¯é 

---

## ğŸ“‹ ç›®å½•

1. [äº¤äº’æ€»ä½“è®¾è®¡](#äº¤äº’æ€»ä½“è®¾è®¡)
2. [è®¤è¯å’Œæˆæƒ](#è®¤è¯å’Œæˆæƒ)
3. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
4. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
5. [æ•°æ®åŒæ­¥ç­–ç•¥](#æ•°æ®åŒæ­¥ç­–ç•¥)
6. [å®æ—¶é€šçŸ¥](#å®æ—¶é€šçŸ¥)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [å®‰å…¨å®ç°](#å®‰å…¨å®ç°)

---

## äº¤äº’æ€»ä½“è®¾è®¡

### å‰åç«¯é€šä¿¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æµè§ˆå™¨/å®¢æˆ·ç«¯                              â”‚
â”‚         (React 18 + TypeScript)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Store (Zustand)                                       â”‚
â”‚  â”œâ”€ userStore      (ç”¨æˆ·çŠ¶æ€)                         â”‚
â”‚  â”œâ”€ projectStore   (é¡¹ç›®çŠ¶æ€)                         â”‚
â”‚  â”œâ”€ editorStore    (ç¼–è¾‘å™¨çŠ¶æ€)                       â”‚
â”‚  â””â”€ designStore    (è®¾è®¡çŠ¶æ€)                         â”‚
â”‚                                                         â”‚
â”‚  â†“â†‘ (dispatch/subscribe)                              â”‚
â”‚                                                         â”‚
â”‚  Services Layer                                         â”‚
â”‚  â”œâ”€ authApi        (è®¤è¯ç›¸å…³)                         â”‚
â”‚  â”œâ”€ projectApi     (é¡¹ç›®ç®¡ç†)                         â”‚
â”‚  â”œâ”€ designApi      (è®¾è®¡ç”Ÿæˆ)                         â”‚
â”‚  â”œâ”€ exportApi      (å¯¼å‡ºåŠŸèƒ½)                         â”‚
â”‚  â””â”€ axiosInstance  (HTTPå®¢æˆ·ç«¯)                       â”‚
â”‚       â†“â†‘                                               â”‚
â”‚       â”œâ”€ è¯·æ±‚æ‹¦æˆª: æ·»åŠ Token, æ—¥å¿—                  â”‚
â”‚       â””â”€ å“åº”æ‹¦æˆª: é”™è¯¯å¤„ç†, Tokenåˆ·æ–°              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPS + WebSocket
         â”‚ â”œâ”€ JSONè¯·æ±‚ä½“
         â”‚ â””â”€ JWT TokenéªŒè¯
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            APIç½‘å…³ (Kong)                              â”‚
â”‚                                                        â”‚
â”‚  â”œâ”€ è·¯ç”±è½¬å‘åˆ°å¯¹åº”å¾®æœåŠ¡                              â”‚
â”‚  â”œâ”€ JWTéªŒè¯ + é€Ÿç‡é™åˆ¶                                â”‚
â”‚  â”œâ”€ è¯·æ±‚æ—¥å¿—è®°å½•                                      â”‚
â”‚  â””â”€ CORSå¤„ç†                                          â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                         â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Svc   â”‚        â”‚ Project Svc â”‚   â”‚ Design Svc  â”‚
â”‚ :3001      â”‚        â”‚ :3002       â”‚   â”‚ :3003       â”‚
â”‚            â”‚        â”‚             â”‚   â”‚             â”‚
â”‚ â”œâ”€ Auth    â”‚        â”‚ â”œâ”€ CRUD     â”‚   â”‚ â”œâ”€ Generate â”‚
â”‚ â”œâ”€ Profile â”‚        â”‚ â”œâ”€ Share    â”‚   â”‚ â”œâ”€ Recommendâ”‚
â”‚ â””â”€ OAuth2  â”‚        â”‚ â””â”€ Comment  â”‚   â”‚ â””â”€ Styles   â”‚
â”‚            â”‚        â”‚             â”‚   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚                    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PostgreSQL     â”‚
        â”‚ Redis          â”‚
        â”‚ RabbitMQ       â”‚
        â”‚ S3/CDN         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€šä¿¡æ¨¡å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       é€šä¿¡æ¨¡å¼åˆ†ç±»                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒæ­¥è¯·æ±‚     â”‚ å¼‚æ­¥ä»»åŠ¡     â”‚ å®æ—¶é€šçŸ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GET /users   â”‚ POST /designsâ”‚ WebSocket
â”‚ å³æ—¶è¿”å›     â”‚ 202 Acceptedâ”‚ Server-Sent Events
â”‚              â”‚ åå°å¤„ç†    â”‚ å®æ—¶æ›´æ–°
â”‚              â”‚ è½®è¯¢/å›è°ƒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è®¤è¯å’Œæˆæƒ

### 1. ç™»å½•æµç¨‹ (è¯¦ç»†)

```
ã€å‰ç«¯ (React)ã€‘            ã€åç«¯ (Python FastAPI)ã€‘
      â”‚                          â”‚
      â”œâ”€ ç”¨æˆ·è¾“å…¥é‚®ç®±/å¯†ç       â”‚
      â”‚                          â”‚
      â”œâ”€ è¡¨å•éªŒè¯               â”‚
      â”‚  â”œâ”€ é‚®ç®±æ ¼å¼              â”‚
      â”‚  â””â”€ å¯†ç é•¿åº¦              â”‚
      â”‚                          â”‚
      â”œâ”€ å‘é€è¯·æ±‚â”€â”€POST /auth/loginâ”€â”€â–ºâ”‚
      â”‚   {                       â”‚
      â”‚     "email": "...",      â”‚ â”œâ”€ æŸ¥è¯¢æ•°æ®åº“ (SQLAlchemy)
      â”‚     "password": "..."    â”‚ â”‚
      â”‚   }                       â”‚ â”œâ”€ ä½¿ç”¨passlibéªŒè¯å¯†ç 
      â”‚                          â”‚ â”‚
      â”‚                          â”‚ â”œâ”€ ç”ŸæˆJWT Token (PyJWT)
      â”‚                          â”‚ â”‚  exp: now + 86400s
      â”‚                          â”‚
      â”‚â—„â”€â”€â”€201 Createdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚  {                        â”‚ â”œâ”€ HttpOnly Cookieè®¾ç½®
      â”‚    "access_token": "...",â”‚ â”‚  Refresh Token
      â”‚    "refresh_token": "...",
      â”‚    "expires_in": 86400   â”‚
      â”‚  }                        â”‚
      â”‚                          â”‚
      â”œâ”€ ä¿å­˜Token             â”‚
      â”‚  â”œâ”€ AccessToken â†’ å†…å­˜ â”‚
      â”‚  â””â”€ RefreshToken â†’ Cookie
      â”‚                          â”‚
      â”œâ”€ è·³è½¬åˆ°Dashboard       â”‚
      â”‚                          â”‚
      â””â”€ è‡ªåŠ¨åˆ·æ–°Token        â”‚
         (æ¯1å°æ—¶)

ã€Tokenåˆ·æ–°æœºåˆ¶ã€‘

å‰ç«¯æ£€æµ‹åˆ°:
  â†’ AccessTokenå¿«è¦è¿‡æœŸ
  â†’ æˆ–APIè¿”å›401

è§¦å‘åˆ·æ–°:
  POST /auth/refresh
  {
    "refresh_token": "..."
  }

åç«¯éªŒè¯:
  âœ“ Tokenç­¾åæœ‰æ•ˆ
  âœ“ Tokenæœªè¿‡æœŸ
  âœ“ Tokenä¸åœ¨é»‘åå• (Redis)

è¿”å›æ–°Token:
  {
    "access_token": "new_...",
    "expires_in": 86400
  }

å‰ç«¯æ›´æ–°:
  localStorage.setItem('accessToken', newToken)
  â†’ é‡è¯•åŸå§‹è¯·æ±‚
```

**å…·ä½“ä»£ç å®ç°**:

```typescript
// frontend: services/api/authApi.ts
export const authApi = {
  login: async (email: string, password: string) => {
    const response = await axiosInstance.post('/auth/login', {
      email,
      password
    })
    return response  // { access_token, refresh_token, expires_in }
  },

  refresh: async (refreshToken: string) => {
    const response = await axiosInstance.post('/auth/refresh', {
      refresh_token: refreshToken
    })
    return response  // { access_token, expires_in }
  }
}

// frontend: axiosInstance æ‹¦æˆªå™¨
axiosInstance.interceptors.response.use(
  response => response.data,
  async error => {
    if (error.response?.status === 401) {
      const refreshToken = getCookie('refreshToken')
      try {
        const { access_token } = await authApi.refresh(refreshToken)
        localStorage.setItem('accessToken', access_token)
        return axiosInstance(error.config)  // é‡è¯•è¯·æ±‚
      } catch {
        redirectToLogin()
      }
    }
    throw error
  }
)

// backend: app/api/v1/endpoints/auth.py (Python FastAPI)
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime, timedelta
from passlib.context import CryptContext
from jose import JWTError, jwt
import uuid

router = APIRouter(prefix="/auth")
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

@router.post("/login", status_code=200)
async def login(
    credentials: LoginRequest,
    db: AsyncSession = Depends(get_db)
):
    """ç”¨æˆ·ç™»å½•"""
    # 1. éªŒè¯è¾“å…¥
    if not credentials.email or not credentials.password:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Missing credentials"
        )

    try:
        # 2. æŸ¥è¯¢ç”¨æˆ·
        user = await db.execute(
            select(User).where(User.email == credentials.email)
        )
        user = user.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid credentials"
            )

        # 3. éªŒè¯å¯†ç 
        if not pwd_context.verify(credentials.password, user.password_hash):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid credentials"
            )

        # 4. ç”ŸæˆTokens
        now = datetime.utcnow()
        access_token_expires = now + timedelta(hours=24)
        refresh_token_expires = now + timedelta(days=7)

        # Access Token (å†…å­˜ä¸­)
        access_token = jwt.encode(
            {
                "sub": str(user.id),
                "email": user.email,
                "role": user.role,
                "iat": now,
                "exp": access_token_expires
            },
            settings.JWT_SECRET_KEY,
            algorithm=settings.JWT_ALGORITHM
        )

        # Refresh Token (å­˜å‚¨åœ¨æ•°æ®åº“å’ŒCookieä¸­)
        refresh_token_jti = str(uuid.uuid4())
        refresh_token = jwt.encode(
            {
                "sub": str(user.id),
                "jti": refresh_token_jti,
                "iat": now,
                "exp": refresh_token_expires,
                "type": "refresh"
            },
            settings.REFRESH_TOKEN_SECRET_KEY,
            algorithm=settings.JWT_ALGORITHM
        )

        # 5. è¿”å›Tokens
        response = JSONResponse(
            status_code=200,
            content={
                "access_token": access_token,
                "refresh_token": refresh_token,
                "expires_in": int((access_token_expires - now).total_seconds())
            }
        )

        # è®¾ç½®HttpOnly Cookie
        response.set_cookie(
            key="refresh_token",
            value=refresh_token,
            httponly=True,
            secure=settings.ENVIRONMENT == "production",
            samesite="strict",
            max_age=7 * 24 * 60 * 60  # 7å¤©
        )

        return response

    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Login failed"
        )

@router.post("/refresh", status_code=200)
async def refresh_token(
    token_req: RefreshTokenRequest,
    db: AsyncSession = Depends(get_db),
    cache: Redis = Depends(get_redis)
):
    """åˆ·æ–°è®¿é—®ä»¤ç‰Œ"""
    try:
        # 1. éªŒè¯Refresh Token
        payload = jwt.decode(
            token_req.refresh_token,
            settings.REFRESH_TOKEN_SECRET_KEY,
            algorithms=[settings.JWT_ALGORITHM]
        )

        user_id = payload.get("sub")
        jti = payload.get("jti")

        if not user_id or not jti:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid token"
            )

        # 2. æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­ (Redis)
        blacklist_key = f"token_blacklist:{jti}"
        if await cache.get(blacklist_key):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Token revoked"
            )

        # 3. æŸ¥è¯¢ç”¨æˆ·
        user = await db.get(User, user_id)
        if not user or not user.is_active:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="User not found"
            )

        # 4. ç”Ÿæˆæ–°çš„Access Token
        now = datetime.utcnow()
        access_token_expires = now + timedelta(hours=24)

        access_token = jwt.encode(
            {
                "sub": str(user.id),
                "email": user.email,
                "role": user.role,
                "iat": now,
                "exp": access_token_expires
            },
            settings.JWT_SECRET_KEY,
            algorithm=settings.JWT_ALGORITHM
        )

        return {
            "access_token": access_token,
            "expires_in": int((access_token_expires - now).total_seconds())
        }

    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token"
        )
```

### 2. æƒé™æ£€æŸ¥æµç¨‹

```
ã€å‰ç«¯æ£€æŸ¥ã€‘(æœ¬åœ°éªŒè¯)
GET /api/v1/projects
  â†“
è¯·æ±‚æ‹¦æˆªå™¨:
  â”œâ”€ è·å–Token
  â”œâ”€ è§£ç Token (ä»…éªŒè¯æ ¼å¼)
  â”œâ”€ æ£€æŸ¥expirationæ—¶é—´
  â””â”€ æ·»åŠ åˆ°è¯·æ±‚å¤´

ã€åç«¯æ£€æŸ¥ã€‘(çœŸæ­£çš„æˆæƒ)
POST /api/v1/projects/{id}/update
  â†“
APIç½‘å…³JWTä¸­é—´ä»¶:
  â”œâ”€ éªŒè¯Tokenç­¾å
  â”œâ”€ éªŒè¯Tokenæœ‰æ•ˆæœŸ
  â””â”€ æå–ç”¨æˆ·ä¿¡æ¯

è·¯ç”±å¤„ç†å™¨:
  â”œâ”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºé¡¹ç›®æ‰€æœ‰è€…
  â”‚  Query: SELECT * FROM projects WHERE id=? AND user_id=?
  â”‚  â”œâ”€ å­˜åœ¨ â†’ å…è®¸ä¿®æ”¹
  â”‚  â””â”€ ä¸å­˜åœ¨ â†’ è¿”å›403
  â”‚
  â”œâ”€ æ£€æŸ¥è®¢é˜…çŠ¶æ€
  â”‚  â”œâ”€ Freeç”¨æˆ· â†’ æœ€å¤š5ä¸ªé¡¹ç›®
  â”‚  â”œâ”€ Proç”¨æˆ· â†’ æ— é™é¡¹ç›®
  â”‚  â””â”€ è¶…é™ â†’ è¿”å›402 Payment Required
  â”‚
  â””â”€ æ£€æŸ¥æ“ä½œæƒé™
     â”œâ”€ ç®¡ç†å‘˜ â†’ å…¨éƒ¨æ“ä½œ
     â”œâ”€ ç”¨æˆ· â†’ è‡ªå·±çš„é¡¹ç›®
     â””â”€ æ¸¸å®¢ â†’ ä»…è¯»æƒé™
```

---

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### æµç¨‹1: åˆ›å»ºé¡¹ç›® â†’ ç”Ÿæˆè®¾è®¡ â†’ å¯¼å‡º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºé¡¹ç›®å¹¶ç”Ÿæˆè®¾è®¡çš„å®Œæ•´æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å‰ç«¯ã€‘                       ã€åç«¯ã€‘

1ï¸âƒ£ ç”¨æˆ·ç‚¹å‡»"æ–°å»ºé¡¹ç›®"
   â”œâ”€ æ˜¾ç¤ºå¯¹è¯æ¡†
   â””â”€ ç”¨æˆ·è¾“å…¥:
      â€¢ é¡¹ç›®åç§°
      â€¢ å°ºå¯¸ (1080Ã—1080)
      â€¢ æè¿° (å¯é€‰)

2ï¸âƒ£ æäº¤é¡¹ç›®åˆ›å»ºè¯·æ±‚
   POST /api/v1/projects
   {
     "title": "åŒ11å¤§ä¿ƒ",
     "width": 1080,
     "height": 1080,
     "description": "..."
   }

   â”œâ”€ å‰ç«¯çŠ¶æ€æ›´æ–°
   â”‚  projectStore.setLoading(true)
   â”‚
   â””â”€ å‘é€è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
                                   â”‚
                                   â”œâ”€ éªŒè¯è¾“å…¥
                                   â”œâ”€ æ£€æŸ¥é…é¢
                                   â”‚  (Free: â‰¤5é¡¹ç›®)
                                   â”œâ”€ åˆ›å»ºé¡¹ç›®è®°å½•
                                   â”‚  INSERT INTO projects
                                   â”‚  RETURNING id, created_at
                                   â””â”€ è¿”å›201 Created
                                      {
                                        "id": "proj_123",
                                        "title": "...",
                                        "status": "draft"
                                      }

3ï¸âƒ£ ä¿å­˜é¡¹ç›®IDå¹¶è¿›å…¥ç¼–è¾‘ç•Œé¢
   â”œâ”€ projectStore.setCurrentProject(project)
   â”œâ”€ å¯¼èˆªåˆ° /editor/proj_123
   â””â”€ åˆå§‹åŒ–ç¼–è¾‘å™¨

4ï¸âƒ£ ç”¨æˆ·å¡«å……å†…å®¹
   â”œâ”€ æ ‡é¢˜: "åŒ11å¤§ä¿ƒ"
   â”œâ”€ å‰¯æ ‡é¢˜: "å…¨åœº5æŠ˜"
   â”œâ”€ æ­£æ–‡: "æ´»åŠ¨è¯¦æƒ…..."
   â”œâ”€ CTA: "ç«‹å³è´­ä¹°"
   â”œâ”€ ä¸Šä¼ å›¾ç‰‡: product.jpg
   â”‚
   â””â”€ é€‰æ‹©é£æ ¼: "ç”µå•†ä¿ƒé”€"
      & é…è‰²æ–¹æ¡ˆ: "çº¢é»„é…"

5ï¸âƒ£ ç‚¹å‡»"ç”Ÿæˆè®¾è®¡"
   POST /api/v1/designs/generate
   {
     "projectId": "proj_123",
     "content": {
       "title": "åŒ11å¤§ä¿ƒ",
       "subtitle": "å…¨åœº5æŠ˜",
       ...
     },
     "style": "ecommerce",
     "colorTheme": "red-yellow",
     "variantCount": 3
   }

   â”œâ”€ éªŒè¯è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                               â”‚
   â”‚                               â”œâ”€ å‚æ•°éªŒè¯
   â”‚                               â”œâ”€ æ£€æŸ¥ç”Ÿæˆé€Ÿç‡é™åˆ¶
   â”‚                               â”‚  (é˜²æ­¢æ»¥ç”¨)
   â”‚                               â”‚
   â”‚                               â”œâ”€ åˆ›å»ºä»»åŠ¡è®°å½•
   â”‚                               â”‚  task_id = "task_abc123"
   â”‚                               â”‚
   â”‚                               â””â”€ å‘é€æ¶ˆæ¯åˆ°RabbitMQ
   â”‚                                  {
   â”‚                                    "taskId": "task_abc123",
   â”‚                                    "type": "design_generation",
   â”‚                                    "payload": {...}
   â”‚                                  }
   â”‚
   â”‚â—„â”€â”€â”€ 202 Accepted â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”œâ”€ ç«‹å³è¿”å›
   â”‚  {                           â”‚  ä¸é˜»å¡ç­‰å¾…
   â”‚    "taskId": "task_abc123",â”‚
   â”‚    "status": "processing"  â”‚
   â”‚  }                           â”‚
   â”‚                               â”‚
   â”œâ”€ å‰ç«¯ä¿å­˜taskId
   â””â”€ æ˜¾ç¤ºç”ŸæˆåŠ¨ç”»
      "âœ¨ AI æ­£åœ¨ä¸ºä½ è®¾è®¡..."

6ï¸âƒ£ åå°å¼‚æ­¥å¤„ç†
                                  Workerè¿›ç¨‹æ¥æ”¶ä»»åŠ¡
                                  â”œâ”€ åŠ è½½AIæ¨¡å‹ (5ç§’)
                                  â”œâ”€ åˆ†æå†…å®¹
                                  â”œâ”€ ç”Ÿæˆ3ä¸ªå˜ä½“
                                  â”‚  â”œâ”€ å˜ä½“1: å·¦å³å¸ƒå±€
                                  â”‚  â”œâ”€ å˜ä½“2: ä¸Šä¸‹å¸ƒå±€
                                  â”‚  â””â”€ å˜ä½“3: å±…ä¸­å¸ƒå±€
                                  â”œâ”€ ä¿å­˜åˆ°S3
                                  â”‚  s3://bucket/designs/proj_123/
                                  â”‚  â”œâ”€ variant_1.json
                                  â”‚  â”œâ”€ variant_1_preview.jpg
                                  â”‚  â”œâ”€ variant_2.json
                                  â”‚  â””â”€ ...
                                  â”œâ”€ ä¿å­˜åˆ°æ•°æ®åº“
                                  â”‚  INSERT INTO designs
                                  â”‚  (project_id, elements, style, ...)
                                  â”‚
                                  â””â”€ å‘å¸ƒå®Œæˆäº‹ä»¶
                                     {
                                       "event": "design.generated",
                                       "taskId": "task_abc123",
                                       "designs": [...]
                                     }

7ï¸âƒ£ å‰ç«¯è½®è¯¢æŸ¥è¯¢ç»“æœ
   GET /api/v1/tasks/task_abc123

   â”œâ”€ æ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡
   â”œâ”€ è¶…æ—¶: 30ç§’æ”¾å¼ƒ
   â”‚
   â””â”€ åç«¯æŸ¥è¯¢Redis
      â”œâ”€ task:task_abc123:status
      â”œâ”€ å¦‚æœçŠ¶æ€=completed
      â”‚  â””â”€ task:task_abc123:result
      â”‚     [design_data_1, ...]
      â”‚
      â””â”€ è¿”å›200 OK
         {
           "status": "completed",
           "designs": [...]
         }

8ï¸âƒ£ æ˜¾ç¤ºè®¾è®¡å˜ä½“
   â”œâ”€ designStore.setDesigns(designs)
   â”œâ”€ æ˜¾ç¤º3ä¸ªå˜ä½“ç¼©å›¾
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  â”‚ å˜ä½“1   â”‚ â”‚ å˜ä½“2   â”‚ â”‚ å˜ä½“3   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â””â”€ ç”¨æˆ·é€‰æ‹©å…¶ä¸­ä¸€ä¸ª
      â†’ è¿›å…¥ç¼–è¾‘ç•Œé¢

9ï¸âƒ£ ç”¨æˆ·ç¼–è¾‘è®¾è®¡
   â”œâ”€ ä¿®æ”¹æ–‡æœ¬
   â”œâ”€ è°ƒæ•´é¢œè‰²
   â”œâ”€ ç§»åŠ¨å…ƒç´ 
   â”‚
   â””â”€ æ¯2ç§’è‡ªåŠ¨ä¿å­˜
      PUT /api/v1/projects/proj_123/designs/design_v1
      {
        "elements": [...],
        "style": "...",
        "content": {...}
      }

ğŸ”Ÿ å¯¼å‡ºè®¾è®¡
   POST /api/v1/exports
   {
     "designId": "design_v1",
     "format": "png",
     "resolution": "high",
     "width": 1080,
     "height": 1080
   }

   â”œâ”€ å‘é€åˆ°RabbitMQâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                 â”‚
   â”‚â—„â”€â”€â”€ 202 Accepted â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”œâ”€ åå°å¤„ç†
   â”‚  { "exportId": "exp_xyz" }     â”‚
   â”‚                                 â”‚
   â”‚                                 â”œâ”€ åŠ è½½è®¾è®¡æ•°æ®
   â”‚                                 â”œâ”€ ä½¿ç”¨Sharpæ¸²æŸ“PNG
   â”‚                                 â”œâ”€ ä¸Šä¼ åˆ°S3
   â”‚                                 â”œâ”€ ç”Ÿæˆç­¾åURL
   â”‚                                 â”‚  (24å°æ—¶è¿‡æœŸ)
   â”‚                                 â”‚
   â”‚ è½®è¯¢ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ GET /api/v1/exports/exp_xyz    â”‚
   â”‚                                 â”‚
   â”‚â—„â”€â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  {                             â”‚
   â”‚    "status": "completed",      â”‚
   â”‚    "downloadUrl": "https://..." â”‚
   â”‚  }                             â”‚
   â”‚                                 â”‚
   â”œâ”€ è§¦å‘ä¸‹è½½
   â””â”€ æ˜¾ç¤ºæˆåŠŸæç¤º
```

### æµç¨‹2: å®æ—¶è‡ªåŠ¨ä¿å­˜

```
ã€ç¼–è¾‘å™¨å®æ—¶ä¿å­˜æœºåˆ¶ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­è¿›è¡Œç¼–è¾‘              â”‚
â”‚ â€¢ è¾“å…¥æ–‡æœ¬                          â”‚
â”‚ â€¢ æ‹–æ‹½å…ƒç´                           â”‚
â”‚ â€¢ è°ƒæ•´å±æ€§                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ editorStoreæ›´æ–° (å³æ—¶)
             â”‚
             â””â”€ è§¦å‘debouncedä¿å­˜
                (å»¶è¿Ÿ2ç§’)

             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ ç­‰å¾…2ç§’å†…æ˜¯å¦æœ‰å…¶ä»–å˜åŒ– â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ æ— æ–°çš„å˜åŒ– â†’ å‘é€ä¿å­˜è¯·æ±‚ â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                  PUT /designs/v1
                  {
                    "elements": [...],
                    "updatedAt": timestamp
                  }

                  â”œâ”€ ä¼˜åŒ–ä¸Šä¼ 
                  â”‚  â€¢ åªå‘é€å˜åŒ–çš„éƒ¨åˆ† (delta)
                  â”‚  â€¢ å‹ç¼©JSON
                  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ åç«¯
                                         â”‚
                                         â”œâ”€ ä½¿ç”¨ä¹è§‚é”
                                         â”‚  WHERE version = current_version
                                         â”‚
                                         â”œâ”€ ç‰ˆæœ¬å†²çªå¤„ç†
                                         â”‚  æ›´æ–°å¤±è´¥ â†’ 409 Conflict
                                         â”‚  â†’ é€šçŸ¥å‰ç«¯å†²çª
                                         â”‚  â†’ æç¤ºç”¨æˆ·é€‰æ‹©åˆå¹¶æˆ–è¦†ç›–
                                         â”‚
                                         â””â”€ ä¿å­˜æˆåŠŸ
                                            ç¼“å­˜å†™å…¥Redis
                                            design:{id}:cache

             â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             â”‚  {                      â”‚
             â”‚    "version": 2,        â”‚
             â”‚    "savedAt": "..."     â”‚
             â”‚  }                      â”‚
             â”‚                         â”‚
             â”œâ”€ æ›´æ–°æœ¬åœ°çŠ¶æ€
             â”‚  editorStore.setSaved(true)
             â”‚
             â””â”€ æ˜¾ç¤º"å·²ä¿å­˜âœ“"æç¤º (2ç§’åæ¶ˆå¤±)
```

---

## é”™è¯¯å¤„ç†æœºåˆ¶

### é”™è¯¯åˆ†ç±»å’Œå¤„ç†

```
ã€HTTPé”™è¯¯åˆ†ç±»å’Œå¤„ç†æ–¹æ¡ˆã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€ç      â”‚ é”™è¯¯ç±»å‹     â”‚ å¤„ç†æ–¹æ¡ˆ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 400        â”‚ è¯·æ±‚æ ¼å¼é”™è¯¯ â”‚ æ˜¾ç¤ºå…·ä½“å­—æ®µéªŒè¯é”™è¯¯           â”‚
â”‚            â”‚              â”‚ "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"               â”‚
â”‚            â”‚              â”‚ "å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦"              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 401        â”‚ æœªè®¤è¯       â”‚ åˆ·æ–°Tokenæˆ–è·³è½¬åˆ°ç™»å½•é¡µ        â”‚
â”‚            â”‚              â”‚ å¦‚æœåˆ·æ–°å¤±è´¥ â†’ æ¸…é™¤æœ¬åœ°Token   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 403        â”‚ æ— æƒé™       â”‚ æ˜¾ç¤ºæç¤º "æ— æƒé™è®¿é—®æ­¤èµ„æº"    â”‚
â”‚            â”‚              â”‚ ä¸é‡è¯•ï¼Œæç¤ºå‡çº§æˆ–è”ç³»æ”¯æŒ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 404        â”‚ èµ„æºä¸å­˜åœ¨   â”‚ æ ¹æ®åœºæ™¯å¤„ç†                   â”‚
â”‚            â”‚              â”‚ â€¢ é¡¹ç›®åˆ é™¤ â†’ è¿”å›é¡¹ç›®åˆ—è¡¨      â”‚
â”‚            â”‚              â”‚ â€¢ 404é¡µé¢ â†’ æ˜¾ç¤º404é¡µé¢        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 409        â”‚ å†²çª         â”‚ å¤šç«¯ç¼–è¾‘å†²çªå¤„ç†               â”‚
â”‚            â”‚              â”‚ â€¢ æ˜¾ç¤ºå†²çªæç¤º                 â”‚
â”‚            â”‚              â”‚ â€¢ æä¾›"ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬"é€‰é¡¹       â”‚
â”‚            â”‚              â”‚ â€¢ æä¾›"ä½¿ç”¨æœåŠ¡å™¨ç‰ˆæœ¬"é€‰é¡¹     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 429        â”‚ é€Ÿç‡é™åˆ¶     â”‚ æ˜¾ç¤º "è¯·æ±‚è¿‡äºé¢‘ç¹"           â”‚
â”‚            â”‚              â”‚ Retry-After: 60ç§’              â”‚
â”‚            â”‚              â”‚ æŒ‰æŒ‡å®šæ—¶é—´åè‡ªåŠ¨é‡è¯•           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 500        â”‚ æœåŠ¡å™¨é”™è¯¯   â”‚ æ˜¾ç¤º "æœåŠ¡å™¨å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•" â”‚
â”‚            â”‚              â”‚ è‡ªåŠ¨é‡è¯• (æŒ‡æ•°é€€é¿)            â”‚
â”‚            â”‚              â”‚ â€¢ ç¬¬1æ¬¡: ç«‹å³                  â”‚
â”‚            â”‚              â”‚ â€¢ ç¬¬2æ¬¡: 2ç§’å                 â”‚
â”‚            â”‚              â”‚ â€¢ ç¬¬3æ¬¡: 4ç§’å                 â”‚
â”‚            â”‚              â”‚ â€¢ ç¬¬4æ¬¡: 8ç§’å                 â”‚
â”‚            â”‚              â”‚ â€¢ è¶…è¿‡4æ¬¡: æ˜¾ç¤ºé”™è¯¯            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”¤
â”‚ 503        â”‚ æœåŠ¡ä¸å¯ç”¨   â”‚ æ˜¾ç¤º "æœåŠ¡ç»´æŠ¤ä¸­ï¼Œè¯·ç¨å"     â”‚
â”‚            â”‚              â”‚ æ¯10ç§’è‡ªåŠ¨é‡è¯•                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°ç¤ºä¾‹

```typescript
// frontend: services/api/errorHandler.ts
export const createErrorHandler = () => {
  return {
    handle: (error: AxiosError) => {
      const status = error.response?.status
      const message = (error.response?.data as any)?.message

      switch (status) {
        case 400:
          return handleValidationError(error.response?.data)
        case 401:
          return handleAuthError()
        case 403:
          return handleForbiddenError()
        case 404:
          return handleNotFoundError()
        case 409:
          return handleConflictError(error.response?.data)
        case 429:
          return handleRateLimitError(error.response?.headers)
        case 500:
        case 503:
          return handleServerError(status)
        default:
          return handleUnknownError(error)
      }
    },

    shouldRetry: (error: AxiosError, attempt: number): boolean => {
      if (attempt > 3) return false
      const status = error.response?.status
      // åªé‡è¯•5xxå’Œç½‘ç»œé”™è¯¯
      return !error.response || status === 500 || status === 503
    },

    getRetryDelay: (attempt: number): number => {
      // æŒ‡æ•°é€€é¿: 1ç§’, 2ç§’, 4ç§’, 8ç§’
      return Math.pow(2, attempt - 1) * 1000
    }
  }
}

// ä½¿ç”¨æ‹¦æˆªå™¨
axiosInstance.interceptors.response.use(
  response => response.data,
  async error => {
    const errorHandler = createErrorHandler()

    if (errorHandler.shouldRetry(error, (error.config as any).retryCount ?? 0)) {
      (error.config as any).retryCount = ((error.config as any).retryCount ?? 0) + 1
      const delay = errorHandler.getRetryDelay((error.config as any).retryCount)
      await sleep(delay)
      return axiosInstance(error.config)
    }

    errorHandler.handle(error)
    throw error
  }
)
```

---

## æ•°æ®åŒæ­¥ç­–ç•¥

### æœ¬åœ°çŠ¶æ€ä¸æœåŠ¡å™¨åŒæ­¥

```
ã€ä¸‰å±‚æ•°æ®ä¸€è‡´æ€§æ¨¡å‹ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§1: æœ¬åœ°çŠ¶æ€ (Zustand Store)                        â”‚
â”‚ â€¢ å³æ—¶æ›´æ–°ï¼ŒUIç«‹å³ååº”                                â”‚
â”‚ â€¢ å¯èƒ½ä¸æœåŠ¡å™¨ä¸ä¸€è‡´                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”œâ”€ è‡ªåŠ¨ä¿å­˜
                        â”‚  (å»¶è¿Ÿ2ç§’)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§2: æœåŠ¡å™¨çŠ¶æ€ (æ•°æ®åº“)                            â”‚
â”‚ â€¢ çœŸå®çš„æºæ•°æ®                                        â”‚
â”‚ â€¢ å¤šç”¨æˆ·å…±äº«æ•°æ®æº                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”œâ”€ èƒŒæ™¯åŒæ­¥
                        â”‚  (å®šæœŸæ£€æŸ¥)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§3: ç¼“å­˜çŠ¶æ€ (Redis)                               â”‚
â”‚ â€¢ å¿«é€Ÿè¯»å–ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›                            â”‚
â”‚ â€¢ 1åˆ†é’Ÿè¿‡æœŸ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å†²çªè§£å†³ã€‘

åœºæ™¯1: æœ¬åœ°ç¦»çº¿ç¼–è¾‘
  ç”¨æˆ·ç¼–è¾‘ â†’ ç¦»çº¿ â†’ æ¢å¤è¿æ¥
  â”œâ”€ æ£€æµ‹æœ¬åœ°ç‰ˆæœ¬ > æœåŠ¡å™¨ç‰ˆæœ¬
  â”œâ”€ å‘é€åˆå¹¶è¯·æ±‚
  â””â”€ æœåŠ¡å™¨æ¥å— (æœ¬åœ°ä¼˜å…ˆ)

åœºæ™¯2: å¤šè®¾å¤‡åŒæ—¶ç¼–è¾‘
  è®¾å¤‡Aæ›´æ–°æˆåŠŸ â†’ ç‰ˆæœ¬v2
  è®¾å¤‡BåŸºäºv1æ›´æ–° â†’ å†²çª
  â”œâ”€ æ£€æµ‹ç‰ˆæœ¬å†²çª (409)
  â”œâ”€ å¼¹å‡ºå†²çªè§£å†³å¯¹è¯æ¡†
  â”‚  [ ä½¿ç”¨æˆ‘çš„ç‰ˆæœ¬ ] [ ä½¿ç”¨æœåŠ¡å™¨ç‰ˆæœ¬ ]
  â””â”€ ç”¨æˆ·é€‰æ‹©ä¸€ä¸ª

åœºæ™¯3: å¹¶å‘è¯·æ±‚
  ç”¨æˆ·å¿«é€Ÿä¿®æ”¹å¤šä¸ªå­—æ®µ
  â”œâ”€ è¯·æ±‚1: title (å‘é€)
  â”œâ”€ è¯·æ±‚2: color (æ’é˜Ÿ)
  â”œâ”€ è¯·æ±‚1: æˆåŠŸ, v2
  â””â”€ è¯·æ±‚2: åŸºäºv2å‘é€
```

---

## å®æ—¶é€šçŸ¥

### WebSocketå®ç°æ–¹æ¡ˆ

```
ã€å®æ—¶é€šçŸ¥æ¶æ„ã€‘

å‰ç«¯è¿æ¥:
  const ws = new WebSocket('wss://api.example.com/ws')

  â”œâ”€ èº«ä»½è®¤è¯
  â”‚  ws.send({
  â”‚    type: 'auth',
  â”‚    token: accessToken
  â”‚  })
  â”‚
  â””â”€ è®¢é˜…äº‹ä»¶
     ws.send({
       type: 'subscribe',
       channels: [
         'project:proj_123:changes',
         'design:design_v1:updates'
       ]
     })

åç«¯å¹¿æ’­:
  â€¢ ç”¨æˆ·Aæ›´æ–°é¡¹ç›®
  â€¢ å‘å¸ƒäº‹ä»¶: project:proj_123:updated
  â€¢ å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…

  {
    type: 'update',
    channel: 'project:proj_123:changes',
    data: {
      field: 'title',
      value: 'æ–°æ ‡é¢˜',
      updatedBy: 'user_b',
      timestamp: 1698345600000
    }
  }

å‰ç«¯æ¥æ”¶:
  ws.onmessage = (event) => {
    const message = JSON.parse(event.data)
    if (message.type === 'update') {
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      projectStore.updateProject(message.data)
      // æ˜¾ç¤ºé€šçŸ¥
      toast.info(`${message.data.updatedBy} æ›´æ–°äº†é¡¹ç›®`)
    }
  }

ã€å¤‡é€‰æ–¹æ¡ˆ: Server-Sent Eventsã€‘
(é€‚åˆå•å‘æ¨é€ï¼Œå¦‚å¯¼å‡ºå®Œæˆé€šçŸ¥)

å‰ç«¯ç›‘å¬:
  const eventSource = new EventSource(
    '/api/v1/events?token=...'
  )

  eventSource.addEventListener('export.completed', (event) => {
    const data = JSON.parse(event.data)
    downloadFile(data.url)
  })

åç«¯æ¨é€:
  res.write('event: export.completed\n')
  res.write(`data: ${JSON.stringify(data)}\n\n`)
```

---

## æ€§èƒ½ä¼˜åŒ–

### è¯·æ±‚ä¼˜åŒ–

```
ã€åˆå¹¶è¯·æ±‚ã€‘
âœ— ä¸å¥½çš„åšæ³•:
  æ‰¹é‡ä¿å­˜10ä¸ªå…ƒç´ :
  PUT /designs/elem_1
  PUT /designs/elem_2
  PUT /designs/elem_3
  ...
  10ä¸ªè¯·æ±‚ = é«˜å»¶è¿Ÿ

âœ“ å¥½çš„åšæ³•:
  PATCH /designs/batch
  {
    "updates": [
      { "id": "elem_1", "changes": {...} },
      { "id": "elem_2", "changes": {...} },
      ...
    ]
  }
  1ä¸ªè¯·æ±‚ = ä½å»¶è¿Ÿ

ã€å¢é‡æ›´æ–°ã€‘
âœ— å®Œæ•´æ•°æ® (5KB):
  {
    "id": "design_1",
    "title": "...",
    "elements": [...],  // å‡ ç™¾ä¸ªå…ƒç´ 
    "style": "...",
    ...
  }

âœ“ å¢é‡æ•°æ® (100å­—èŠ‚):
  {
    "op": "update_field",
    "path": "/title",
    "value": "æ–°æ ‡é¢˜"
  }

ã€è¯·æ±‚å»é‡ã€‘
ç”¨æˆ·å¿«é€Ÿç‚¹å‡»"ä¿å­˜"æŒ‰é’®10æ¬¡
  â”œâ”€ ä½¿ç”¨RequestDeduplication
  â”‚  åŒæ—¶è¿›è¡Œçš„ç›¸åŒè¯·æ±‚ â†’ åˆå¹¶ä¸º1ä¸ª
  â”‚
  â””â”€ å½“ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆæ—¶
     æ‰€æœ‰10ä¸ªè°ƒç”¨è€…éƒ½æ”¶åˆ°ç»“æœ

ã€ç¼“å­˜ç­–ç•¥ã€‘
GET /projects
  â”œâ”€ ç¬¬1æ¬¡: æŸ¥è¯¢æ•°æ®åº“
  â”œâ”€ ç»“æœç¼“å­˜åˆ°Redis (10åˆ†é’Ÿ)
  â””â”€ ç¬¬2-10æ¬¡: è¯»å–ç¼“å­˜

æ›´æ–°é¡¹ç›®æ—¶:
  PUT /projects/proj_1
  â”œâ”€ æ›´æ–°æ•°æ®åº“
  â”œâ”€ æ¸…é™¤ç¼“å­˜
  â”‚  DEL project:proj_1:cache
  â””â”€ ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°ç”Ÿæˆç¼“å­˜
```

---

## å®‰å…¨å®ç°

### ç«¯åˆ°ç«¯å®‰å…¨

```
ã€HTTPSä¼ è¾“ã€‘
âœ“ æ‰€æœ‰é€šä¿¡ä½¿ç”¨HTTPS
âœ“ å¼ºåˆ¶HSTSå¤´
âœ“ è¯ä¹¦é’‰æ‰ (Certificate Pinning)

ã€CORSè®¾ç½®ã€‘
Access-Control-Allow-Origin: https://app.example.com
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 86400

ã€CSRFé˜²æŠ¤ã€‘
å‰ç«¯:
  â€¢ RefreshTokenå­˜åœ¨HttpOnly Cookie
  â€¢ AccessTokenå­˜åœ¨å†…å­˜
  â€¢ æ¯ä¸ªPOSTè¯·æ±‚åŒ…å«CSRFä»¤ç‰Œ

åç«¯:
  â€¢ éªŒè¯CSRFä»¤ç‰Œ
  â€¢ æ£€æŸ¥Origin/Refererå¤´

ã€XSSé˜²æŠ¤ã€‘
å‰ç«¯:
  â€¢ Reactè‡ªåŠ¨è½¬ä¹‰JSX
  â€¢ DOMPurifyæ¸…ç†ç”¨æˆ·è¾“å…¥çš„å¯Œæ–‡æœ¬
  â€¢ Content-Security-Policyå¤´

ã€æ•°æ®åŠ å¯†ã€‘
ç”¨æˆ·æ•æ„Ÿæ•°æ®:
  â€¢ å¯†ç : bcrypt hash (10è½®)
  â€¢ API Token: AES-256åŠ å¯†å­˜å‚¨
  â€¢ æ–‡ä»¶: S3æœåŠ¡ç«¯åŠ å¯†
```

---

**å‰åç«¯äº¤äº’è®¾è®¡å®Œæˆï¼**

æ ¸å¿ƒè¦ç‚¹ï¼š
- âœ… å¼‚æ­¥ä»»åŠ¡æ¨¡å¼ (202 Accepted)
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… æ™ºèƒ½é”™è¯¯é‡è¯•å’Œå¤„ç†
- âœ… ç‰ˆæœ¬å†²çªè§£å†³
- âœ… å®æ—¶é€šçŸ¥æ”¯æŒ
- âœ… å®Œå–„çš„å®‰å…¨æœºåˆ¶
