# æ™ºç»˜æµ·æŠ¥ - åç«¯ç³»ç»Ÿæ¶æ„è®¾è®¡

**ç‰ˆæœ¬**: V2.0 (Python FastAPI)
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ26æ—¥
**è®¾è®¡èŒƒå›´**: å¾®æœåŠ¡æ¶æ„ã€æ•°æ®å­˜å‚¨ã€APIç½‘å…³ã€æ¶ˆæ¯é˜Ÿåˆ—ã€éƒ¨ç½²
**æŠ€æœ¯æ ˆ**: Python 3.11+ | FastAPI 0.104+ | SQLAlchemy 2.0+ | PostgreSQL | Redis | RabbitMQ

---

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [å¾®æœåŠ¡è®¾è®¡](#å¾®æœåŠ¡è®¾è®¡)
3. [APIç½‘å…³](#apiç½‘å…³)
4. [æ•°æ®æ¶æ„](#æ•°æ®æ¶æ„)
5. [æ¶ˆæ¯é˜Ÿåˆ—](#æ¶ˆæ¯é˜Ÿåˆ—)
6. [ç¼“å­˜ç­–ç•¥](#ç¼“å­˜ç­–ç•¥)
7. [æ–‡ä»¶å­˜å‚¨](#æ–‡ä»¶å­˜å‚¨)
8. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
9. [ç›‘æ§å‘Šè­¦](#ç›‘æ§å‘Šè­¦)
10. [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)

---

## æ•´ä½“æ¶æ„

### æ¶æ„æ€»ä½“è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                              â”‚
â”‚              (Webæµè§ˆå™¨ / ç§»åŠ¨åº”ç”¨ / æ¡Œé¢åº”ç”¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS/WebSocket
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   APIç½‘å…³ (Kong)    â”‚ â—„â”€â”€ æµé‡æ§åˆ¶ã€é™æµã€è®¤è¯
        â”‚  :8080/:8443        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ è·¯ç”±è½¬å‘          â”‚
        â”‚ â€¢ JWTéªŒè¯           â”‚
        â”‚ â€¢ è¯·æ±‚æ—¥å¿—          â”‚
        â”‚ â€¢ é€Ÿç‡é™åˆ¶          â”‚
        â”‚ â€¢ CORSå¤„ç†          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼            â–¼            â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡â”‚   â”‚é¡¹ç›®æœåŠ¡â”‚  â”‚è®¾è®¡æœåŠ¡â”‚    â”‚å¯¼å‡ºæœåŠ¡â”‚
â”‚:3001  â”‚   â”‚:3002  â”‚  â”‚:3003  â”‚    â”‚:3004  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Auth    â”‚   â”‚CRUD   â”‚  â”‚æ’ç‰ˆ    â”‚    â”‚PNG/JPG â”‚
â”‚Profile â”‚   â”‚Share  â”‚  â”‚é…è‰²    â”‚    â”‚HTML    â”‚
â”‚OAuth2  â”‚   â”‚ç‰ˆæœ¬   â”‚  â”‚AIé£æ ¼  â”‚    â”‚PDF     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚            â”‚              â”‚
    â”‚            â”‚        â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”¤ RabbitMQ       â”‚
         â”‚            â”‚   â”‚(æ¶ˆæ¯é˜Ÿåˆ—)      â”‚
         â”‚            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚            â”‚        â”‚
         â–¼            â–¼        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL (ä¸»æ•°æ®åº“)        â”‚
    â”‚   â€¢ ç”¨æˆ·æ•°æ®                   â”‚
    â”‚   â€¢ é¡¹ç›®æ•°æ®                   â”‚
    â”‚   â€¢ è®¾è®¡å…ƒç´                    â”‚
    â”‚   â€¢ å¯¼å‡ºè®°å½•                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Redis (ç¼“å­˜ + Session)       â”‚
    â”‚   â€¢ ç”¨æˆ·ä¼šè¯                   â”‚
    â”‚   â€¢ é¢‘ç¹æŸ¥è¯¢ç¼“å­˜               â”‚
    â”‚   â€¢ ä»»åŠ¡é˜Ÿåˆ—                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   S3/å¯¹è±¡å­˜å‚¨ (æ–‡ä»¶å­˜å‚¨)       â”‚
    â”‚   â€¢ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡               â”‚
    â”‚   â€¢ ç”Ÿæˆçš„æµ·æŠ¥                 â”‚
    â”‚   â€¢ ç´ æåº“èµ„æº                 â”‚
    â”‚   â€¢ CDNåˆ†å‘                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å¤–éƒ¨æœåŠ¡é›†æˆ                 â”‚
    â”‚   â€¢ AIæ¨¡å‹æœåŠ¡ (æ’ç‰ˆ/é…è‰²)    â”‚
    â”‚   â€¢ æ”¯ä»˜ç½‘å…³ (Stripe)          â”‚
    â”‚   â€¢ é‚®ä»¶æœåŠ¡ (SendGrid)        â”‚
    â”‚   â€¢ ç›‘æ§æœåŠ¡ (Datadog)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Kubernetesé›†ç¾¤               â”‚
    â”‚   â€¢ Podè‡ªåŠ¨ä¼¸ç¼©                â”‚
    â”‚   â€¢ è´Ÿè½½å‡è¡¡                   â”‚
    â”‚   â€¢ ç°åº¦å‘å¸ƒ                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¾®æœåŠ¡è®¾è®¡

### æœåŠ¡åˆ—è¡¨å’ŒèŒè´£

#### 1. ç”¨æˆ·æœåŠ¡ (User Service) - Port 3001

**èŒè´£**: ç”¨æˆ·è®¤è¯ã€æˆæƒã€ä¸ªäººä¿¡æ¯ç®¡ç†

```python
# FastAPI è·¯ç”±ç¤ºä¾‹
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter(prefix="/api/v1")

# è®¤è¯ç›¸å…³
@router.post("/auth/register", status_code=201)
async def register(user_in: UserCreate, db: AsyncSession = Depends(get_db)):
    """ç”¨æˆ·æ³¨å†Œ"""
    pass

@router.post("/auth/login")
async def login(credentials: LoginSchema, db: AsyncSession = Depends(get_db)):
    """ç”¨æˆ·ç™»å½•"""
    pass

@router.post("/auth/refresh")
async def refresh_token(token: RefreshTokenSchema):
    """åˆ·æ–°è®¿é—®ä»¤ç‰Œ"""
    pass

@router.post("/auth/logout")
async def logout(current_user: User = Depends(get_current_user)):
    """ç”¨æˆ·ç™»å‡º"""
    pass

# ç”¨æˆ·ç®¡ç†
@router.get("/users/{user_id}", response_model=UserResponse)
async def get_user(user_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–ç”¨æˆ·ä¿¡æ¯"""
    pass

@router.put("/users/{user_id}", response_model=UserResponse)
async def update_user(user_id: UUID, user_in: UserUpdate,
                      db: AsyncSession = Depends(get_db),
                      current_user: User = Depends(get_current_user)):
    """æ›´æ–°ç”¨æˆ·ä¿¡æ¯"""
    pass

@router.get("/users/{user_id}/profile", response_model=ProfileResponse)
async def get_profile(user_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–ä¸ªäººèµ„æ–™"""
    pass

@router.put("/users/{user_id}/profile", response_model=ProfileResponse)
async def update_profile(user_id: UUID, profile_in: ProfileUpdate,
                         db: AsyncSession = Depends(get_db)):
    """æ›´æ–°ä¸ªäººèµ„æ–™"""
    pass

@router.post("/users/{user_id}/avatar")
async def upload_avatar(user_id: UUID, file: UploadFile = File(...),
                       db: AsyncSession = Depends(get_db)):
    """æ›´æ–°å¤´åƒ"""
    pass

@router.get("/subscriptions/{user_id}", response_model=SubscriptionResponse)
async def get_subscription(user_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–è®¢é˜…çŠ¶æ€"""
    pass

# å†…éƒ¨æ¥å£ï¼ˆä»…ä¾›å…¶ä»–æœåŠ¡è°ƒç”¨ï¼‰
@router.get("/internal/users/{user_id}", response_model=UserResponse)
async def get_user_internal(user_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–ç”¨æˆ·ï¼ˆä¸éœ€è¦tokenï¼‰"""
    pass

@router.post("/internal/users/{user_id}/verify-token")
async def verify_token_internal(user_id: UUID, token: str, db: AsyncSession = Depends(get_db)):
    """éªŒè¯ç”¨æˆ·ä»¤ç‰Œ"""
    pass
```

**ä¾èµ–**: Redis (sessionå­˜å‚¨), PostgreSQL (ç”¨æˆ·æ•°æ®)

**ç‰¹æ®ŠåŠŸèƒ½**:
- JWT tokenç”Ÿæˆå’ŒéªŒè¯ (PyJWT)
- OAuth2é›†æˆï¼ˆGoogleã€å¾®ä¿¡ï¼‰
- 2FAæ”¯æŒ (pyotp)
- è§’è‰²æƒé™ç®¡ç† (Casbin)
- å¯†ç åŠ å¯† (passlib + bcrypt)

---

#### 2. é¡¹ç›®æœåŠ¡ (Project Service) - Port 3002

**èŒè´£**: é¡¹ç›®çš„CRUDã€ç‰ˆæœ¬ç®¡ç†ã€å›¢é˜Ÿåä½œ

```python
# FastAPI é¡¹ç›®æœåŠ¡è·¯ç”±
@router.get("/projects", response_model=PaginatedResponse[ProjectResponse])
async def list_projects(
    skip: int = 0,
    limit: int = 20,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """è·å–é¡¹ç›®åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰"""
    pass

@router.post("/projects", response_model=ProjectResponse, status_code=201)
async def create_project(
    project_in: ProjectCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """åˆ›å»ºé¡¹ç›®"""
    pass

@router.get("/projects/{project_id}", response_model=ProjectDetailResponse)
async def get_project(project_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–é¡¹ç›®è¯¦æƒ…"""
    pass

@router.put("/projects/{project_id}", response_model=ProjectResponse)
async def update_project(
    project_id: UUID,
    project_in: ProjectUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """æ›´æ–°é¡¹ç›®"""
    pass

@router.delete("/projects/{project_id}", status_code=204)
async def delete_project(
    project_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """åˆ é™¤é¡¹ç›®"""
    pass

# è®¾è®¡ç®¡ç†
@router.get("/projects/{project_id}/designs", response_model=List[DesignResponse])
async def list_designs(project_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–è®¾è®¡å†å²"""
    pass

@router.post("/projects/{project_id}/designs", response_model=DesignResponse)
async def save_design(
    project_id: UUID,
    design_in: DesignCreate,
    db: AsyncSession = Depends(get_db)
):
    """ä¿å­˜è®¾è®¡"""
    pass

@router.get("/projects/{project_id}/designs/{design_id}", response_model=DesignResponse)
async def get_design(project_id: UUID, design_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–è®¾è®¡è¯¦æƒ…"""
    pass

@router.put("/projects/{project_id}/designs/{design_id}", response_model=DesignResponse)
async def update_design(
    project_id: UUID,
    design_id: UUID,
    design_in: DesignUpdate,
    db: AsyncSession = Depends(get_db)
):
    """æ›´æ–°è®¾è®¡"""
    pass

# é¡¹ç›®åˆ†äº«
@router.post("/projects/{project_id}/share", response_model=ShareLinkResponse)
async def create_share_link(project_id: UUID, db: AsyncSession = Depends(get_db)):
    """ç”Ÿæˆåˆ†äº«é“¾æ¥"""
    pass

@router.get("/share/{token}", response_model=SharedProjectResponse)
async def access_shared_project(token: str, db: AsyncSession = Depends(get_db)):
    """é€šè¿‡åˆ†äº«é“¾æ¥è®¿é—®é¡¹ç›®"""
    pass

@router.post("/projects/{project_id}/comments", response_model=CommentResponse)
async def add_comment(
    project_id: UUID,
    comment_in: CommentCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """æ·»åŠ è¯„è®º"""
    pass

# å›¢é˜Ÿåä½œ
@router.post("/projects/{project_id}/members", response_model=MemberResponse)
async def add_member(
    project_id: UUID,
    member_in: MemberCreate,
    db: AsyncSession = Depends(get_db)
):
    """æ·»åŠ å›¢é˜Ÿæˆå‘˜"""
    pass

@router.delete("/projects/{project_id}/members/{member_id}", status_code=204)
async def remove_member(project_id: UUID, member_id: UUID, db: AsyncSession = Depends(get_db)):
    """ç§»é™¤å›¢é˜Ÿæˆå‘˜"""
    pass

@router.put("/projects/{project_id}/members/{member_id}", response_model=MemberResponse)
async def update_member_role(
    project_id: UUID,
    member_id: UUID,
    role_in: MemberRoleUpdate,
    db: AsyncSession = Depends(get_db)
):
    """æ›´æ–°æˆå‘˜æƒé™"""
    pass
```

**ä¾èµ–**: PostgreSQL, Redis (ç¼“å­˜), ç”¨æˆ·æœåŠ¡, RabbitMQ

**ç‰¹æ®ŠåŠŸèƒ½**:
- ä¹è§‚é”å®ç°ç‰ˆæœ¬å†²çªå¤„ç† (SQLAlchemy version_id_col)
- è‡ªåŠ¨ä¿å­˜å’Œè‰ç¨¿ç®¡ç†
- WebSocketå®æ—¶åä½œï¼ˆä½¿ç”¨ aioredis pubsubï¼‰
- é¡¹ç›®æ¨¡æ¿å’Œå…‹éš†
- å˜æ›´å†å²è®°å½• (audit log)

---

#### 3. è®¾è®¡æœåŠ¡ (Design Service) - Port 3003

**èŒè´£**: æ ¸å¿ƒè®¾è®¡ç”Ÿæˆã€æ’ç‰ˆå¼•æ“ã€AIæ¨¡å‹è°ƒç”¨

```python
# FastAPI è®¾è®¡æœåŠ¡è·¯ç”±
from celery import shared_task

@router.post("/designs/generate", response_model=TaskResponse)
async def generate_design(
    design_req: DesignGenerateRequest,
    background_tasks: BackgroundTasks,
    db: AsyncSession = Depends(get_db)
):
    """ç”Ÿæˆè®¾è®¡å˜ä½“ (å¼‚æ­¥ä»»åŠ¡)"""
    # å‘é€åˆ°Celeryä»»åŠ¡é˜Ÿåˆ—
    task = design_generation_task.delay(
        project_id=str(design_req.project_id),
        style=design_req.style,
        variant_count=design_req.variant_count
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.post("/designs/batch-generate", response_model=TaskResponse)
async def batch_generate_designs(
    batch_req: BatchGenerateRequest,
    db: AsyncSession = Depends(get_db)
):
    """æ‰¹é‡ç”Ÿæˆè®¾è®¡"""
    task = batch_design_generation_task.delay(
        project_ids=[str(pid) for pid in batch_req.project_ids],
        styles=batch_req.styles
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.get("/designs/{design_id}", response_model=DesignDetailResponse)
async def get_design_details(design_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–è®¾è®¡è¯¦æƒ…"""
    pass

# è¾…åŠ©åŠŸèƒ½
@router.post("/designs/color-recommend", response_model=ColorRecommendResponse)
async def recommend_colors(
    color_req: ColorRecommendRequest,
    db: AsyncSession = Depends(get_db)
):
    """è‰²å½©æ¨è"""
    pass

@router.post("/designs/layout-suggest", response_model=LayoutSuggestResponse)
async def suggest_layout(
    layout_req: LayoutSuggestRequest,
    db: AsyncSession = Depends(get_db)
):
    """å¸ƒå±€å»ºè®®"""
    pass

@router.post("/designs/extract-entities", response_model=EntitiesResponse)
async def extract_entities(
    content: str,
    db: AsyncSession = Depends(get_db)
):
    """æå–å…³é”®ä¿¡æ¯"""
    pass

# é£æ ¼å’Œç´ æ
@router.get("/styles", response_model=List[StyleResponse])
async def list_styles(cache: Redis = Depends(get_redis)):
    """è·å–æ‰€æœ‰é£æ ¼ï¼ˆç¼“å­˜ï¼‰"""
    pass

@router.get("/styles/{style_id}", response_model=StyleDetailResponse)
async def get_style_details(style_id: str, cache: Redis = Depends(get_redis)):
    """è·å–é£æ ¼è¯¦æƒ…"""
    pass

@router.get("/materials/icons", response_model=List[IconResponse])
async def list_icons(cache: Redis = Depends(get_redis)):
    """è·å–å›¾æ ‡åº“"""
    pass

@router.get("/materials/backgrounds", response_model=List[BackgroundResponse])
async def list_backgrounds(cache: Redis = Depends(get_redis)):
    """è·å–èƒŒæ™¯åº“"""
    pass

@router.get("/materials/fonts", response_model=List[FontResponse])
async def list_fonts(cache: Redis = Depends(get_redis)):
    """è·å–å­—ä½“åº“"""
    pass

# ç”Ÿæˆè¿›åº¦
@router.get("/tasks/{task_id}", response_model=TaskStatusResponse)
async def get_task_status(task_id: str):
    """è·å–ç”Ÿæˆä»»åŠ¡çŠ¶æ€"""
    from celery.result import AsyncResult
    task_result = AsyncResult(task_id)
    return TaskStatusResponse(
        task_id=task_id,
        status=task_result.status,
        result=task_result.result if task_result.successful() else None
    )

# Celery å¼‚æ­¥ä»»åŠ¡å®šä¹‰
@shared_task(bind=True)
def design_generation_task(self, project_id: str, style: str, variant_count: int):
    """è®¾è®¡ç”Ÿæˆä»»åŠ¡"""
    try:
        # åŠ è½½AIæ¨¡å‹
        model = load_design_model()

        # è¿è¡Œæ’ç‰ˆç®—æ³•å’Œé…è‰²æ¨è
        designs = []
        for i in range(variant_count):
            design = model.generate(project_id, style)
            designs.append(design)

        # å­˜å‚¨åˆ°S3
        s3_paths = []
        for design in designs:
            path = save_to_s3(design, project_id)
            s3_paths.append(path)

        # æ›´æ–°æ•°æ®åº“
        update_design_database(project_id, designs)

        return {"status": "success", "designs": s3_paths}
    except Exception as e:
        self.update_state(state='FAILURE', meta={'error': str(e)})
        raise
```

**ä¾èµ–**: PostgreSQL, Redis, RabbitMQ (å¼‚æ­¥ä»»åŠ¡é€šè¿‡Celery), å¤–éƒ¨AIæ¨¡å‹ (é€šè¿‡HTTP API)

**å·¥ä½œæµç¨‹**:
```
ç”¨æˆ·è¯·æ±‚
  â†“
å‚æ•°éªŒè¯
  â†“
å‘é€åˆ°Celeryä»»åŠ¡é˜Ÿåˆ— (RabbitMQ backend)
  â†“ (å¼‚æ­¥)
Celery Workerè¿›ç¨‹
  â†’ åŠ è½½AIæ¨¡å‹
  â†’ è¿è¡Œæ’ç‰ˆç®—æ³•
  â†’ ç”Ÿæˆ3-5ä¸ªå˜ä½“
  â†’ å­˜å‚¨åˆ°S3
  â†’ æ›´æ–°æ•°æ®åº“
  â†“
ç”¨æˆ·è½®è¯¢æˆ–WebSocketæ¥æ”¶ç»“æœ
  â†“
è¿”å›ç”Ÿæˆç»“æœ
```

**ç®—æ³•è¯¦è§£**:
- æ’ç‰ˆå¼•æ“: å†…å®¹åˆ†æ (NLP) â†’ ç©ºé—´è§„åˆ’ (è§„åˆ™å¼•æ“) â†’ å­—ä½“é€‰æ‹© (ç®—æ³•) â†’ å…ƒç´ å¸ƒå±€
- é…è‰²æ¨è: é£æ ¼æ˜ å°„ â†’ è‰²å½©åº“æŸ¥è¯¢ â†’ AIæ¨¡å‹ä¼˜åŒ– (æ·±åº¦å­¦ä¹ æ¨¡å‹)
- å…³é”®ä¿¡æ¯è¯†åˆ«: spaCy/Transformers NLP + è§„åˆ™å¼•æ“

---

#### 4. å¯¼å‡ºæœåŠ¡ (Export Service) - Port 3004

**èŒè´£**: å¤šæ ¼å¼å¯¼å‡ºã€æ–‡ä»¶ç”Ÿæˆ

```python
# FastAPI å¯¼å‡ºæœåŠ¡è·¯ç”±
@router.post("/exports/png", response_model=TaskResponse)
async def export_png(
    export_req: ExportRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """å¯¼å‡ºPNG (å¼‚æ­¥ä»»åŠ¡)"""
    task = export_design_task.delay(
        design_id=str(export_req.design_id),
        format="png",
        resolution=export_req.resolution
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.post("/exports/jpg", response_model=TaskResponse)
async def export_jpg(
    export_req: ExportRequest,
    db: AsyncSession = Depends(get_db)
):
    """å¯¼å‡ºJPG (å¼‚æ­¥ä»»åŠ¡)"""
    task = export_design_task.delay(
        design_id=str(export_req.design_id),
        format="jpg",
        resolution=export_req.resolution
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.post("/exports/html", response_model=TaskResponse)
async def export_html(
    export_req: ExportRequest,
    db: AsyncSession = Depends(get_db)
):
    """å¯¼å‡ºHTML (å¼‚æ­¥ä»»åŠ¡)"""
    task = export_design_task.delay(
        design_id=str(export_req.design_id),
        format="html"
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.post("/exports/pdf", response_model=TaskResponse)
async def export_pdf(
    export_req: ExportRequest,
    db: AsyncSession = Depends(get_db)
):
    """å¯¼å‡ºPDF (å¼‚æ­¥ä»»åŠ¡)"""
    task = export_design_task.delay(
        design_id=str(export_req.design_id),
        format="pdf"
    )
    return TaskResponse(task_id=task.id, status="processing")

@router.get("/exports", response_model=List[ExportResponse])
async def list_exports(
    user_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """è·å–å¯¼å‡ºå†å²"""
    pass

@router.get("/exports/{export_id}", response_model=ExportDetailResponse)
async def get_export_status(export_id: UUID, db: AsyncSession = Depends(get_db)):
    """è·å–å¯¼å‡ºçŠ¶æ€"""
    pass

@router.delete("/exports/{export_id}", status_code=204)
async def delete_export(
    export_id: UUID,
    db: AsyncSession = Depends(get_db)
):
    """åˆ é™¤å¯¼å‡ºæ–‡ä»¶"""
    pass

# Celery å¼‚æ­¥å¯¼å‡ºä»»åŠ¡
@shared_task(bind=True)
def export_design_task(self, design_id: str, format: str, resolution: str = "1080px"):
    """è®¾è®¡å¯¼å‡ºä»»åŠ¡"""
    try:
        # åŠ è½½è®¾è®¡æ•°æ®
        design_data = load_design_from_db(design_id)

        # æ¸²æŸ“åˆ°ç¼“å†²åŒº
        buffer = render_to_buffer(design_data)

        # è½¬æ¢æ ¼å¼
        if format == "png":
            output = convert_to_png(buffer, resolution)
        elif format == "jpg":
            output = convert_to_jpg(buffer, resolution)
        elif format == "html":
            output = convert_to_html(buffer)
        elif format == "pdf":
            output = convert_to_pdf(buffer)

        # ä¸Šä¼ åˆ°S3
        file_path = upload_to_s3(output, design_id, format)

        # ç”Ÿæˆç­¾åä¸‹è½½é“¾æ¥ï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
        download_url = generate_signed_url(file_path, expiration=86400)

        # æ›´æ–°æ•°æ®åº“
        save_export_record(design_id, format, file_path, len(output))

        return {
            "status": "success",
            "file_path": file_path,
            "download_url": download_url,
            "size": len(output)
        }
    except Exception as e:
        self.update_state(state='FAILURE', meta={'error': str(e)})
        raise
```

**ä¾èµ–**: RabbitMQ (Celeryé˜Ÿåˆ—), S3, PostgreSQL

**å¯¼å‡ºæµç¨‹**:
```
ç”¨æˆ·è¯·æ±‚å¯¼å‡º
  â†“
éªŒè¯æƒé™å’Œé…é¢ (æ£€æŸ¥ç”¨æˆ·è®¢é˜…ç­‰çº§)
  â†“
å‘é€ä»»åŠ¡åˆ°Celery (RabbitMQ backend)
  â†“ (Workerå¼‚æ­¥å¤„ç†)
åŠ è½½è®¾è®¡æ•°æ®
  â†“
æ¸²æŸ“åˆ°ç¼“å†²åŒº (ä½¿ç”¨Pillow/Cairo)
  â†“
è½¬æ¢æ ¼å¼
  â”œâ”€ PNG: Pillowåº“ (æ”¯æŒé€æ˜èƒŒæ™¯ã€DPI)
  â”œâ”€ JPG: Pillowåº“ (ç™½è‰²èƒŒæ™¯å¡«å……ã€è´¨é‡è®¾ç½®)
  â”œâ”€ HTML: Jinja2æ¨¡æ¿ + å†…è”CSS
  â””â”€ PDF: Weasyprint + reportlab
  â†“
ä¸Šä¼ åˆ°S3 (å¸¦æœåŠ¡ç«¯åŠ å¯†)
  â†“
ç”Ÿæˆä¸‹è½½é“¾æ¥ï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶çš„ç­¾åURLï¼‰
  â†“
è¿”å›é“¾æ¥ç»™ç”¨æˆ·
```

**æ ¼å¼ç‰¹æ®Šå¤„ç†**:
- PNG: æ”¯æŒé€æ˜èƒŒæ™¯ï¼Œä¸åŒDPI (72/96/300)ï¼Œå°ºå¯¸ä¼˜åŒ–
- JPG: ç™½è‰²èƒŒæ™¯å¡«å……ï¼Œè´¨é‡è®¾ç½® (50-95)ï¼Œè‡ªé€‚åº”å‹ç¼©
- HTML: å“åº”å¼CSSã€é‚®ä»¶å‹å¥½ã€å¯ç¼–è¾‘
- PDF: æ”¯æŒCMYKè‰²å½©ã€PDF/Xæ ‡å‡†ã€çŸ¢é‡åŒ–

---

#### 5. ç´ ææœåŠ¡ (Asset Service) - Port 3005

**èŒè´£**: å›¾æ ‡åº“ã€èƒŒæ™¯åº“ã€å­—ä½“åº“ç®¡ç†

```go
GET    /api/v1/assets/icons/{id}
GET    /api/v1/assets/backgrounds/{id}
GET    /api/v1/assets/fonts/{id}
GET    /api/v1/assets/search             // æœç´¢ç´ æ
POST   /api/v1/assets/upload             // ç”¨æˆ·ä¸Šä¼ ç´ æ
```

**ä¾èµ–**: S3, PostgreSQL, CDN

---

#### 6. åˆ†ææœåŠ¡ (Analytics Service) - Port 3006

**èŒè´£**: ç”¨æˆ·è¡Œä¸ºè¿½è¸ªã€ä½¿ç”¨ç»Ÿè®¡

```go
POST   /api/v1/analytics/events         // ä¸ŠæŠ¥äº‹ä»¶
GET    /api/v1/analytics/dashboard      // è·å–ç»Ÿè®¡ä¿¡æ¯
GET    /api/v1/analytics/trends         // è·å–è¶‹åŠ¿æ•°æ®
```

---

### æœåŠ¡é€šä¿¡æ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      APIç½‘å…³                        â”‚
â”‚    (è¯·æ±‚å…¥å£ç‚¹)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚          â”‚
    â–¼                    â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚User Svc â”‚       â”‚Proj Svc â”‚   â”‚Des Svc  â”‚
â”‚         â”‚       â”‚         â”‚   â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚åŒæ­¥é€šä¿¡ â”‚â—„â”€â”€â”€â”€â”€â”€â”‚åŒæ­¥é€šä¿¡ â”‚   â”‚å¼‚æ­¥ä»»åŠ¡ â”‚
â”‚(gRPC)   â”‚       â”‚(REST)   â”‚   â”‚(é˜Ÿåˆ—)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL    â”‚
        â”‚  Redis         â”‚
        â”‚  RabbitMQ      â”‚
        â”‚  S3            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIç½‘å…³

### Kong APIç½‘å…³é…ç½®

```yaml
# kong.conf æ ¸å¿ƒé…ç½®
database: postgres
postgres_host: db-master.internal
postgres_port: 5432
proxy_listen: 0.0.0.0:8080, 0.0.0.0:8443 ssl
admin_listen: 0.0.0.0:8001

# æ—¥å¿—é…ç½®
log_level: notice
access_logs: /var/log/kong/access.log
```

### è·¯ç”±è§„åˆ™

```lua
-- ç”¨æˆ·æœåŠ¡è·¯ç”±
kong.service.list = {
  {
    name = "user-service",
    url = "http://user-service:3001",
    protocol = "http"
  },
  {
    name = "project-service",
    url = "http://project-service:3002",
    protocol = "http"
  },
  {
    name = "design-service",
    url = "http://design-service:3003",
    protocol = "http"
  },
  {
    name = "export-service",
    url = "http://export-service:3004",
    protocol = "http"
  }
}

-- è·¯ç”±é…ç½®
kong.routes = {
  {
    methods = {"POST"},
    paths = {"/api/v1/auth/register", "/api/v1/auth/login"},
    service = "user-service",
    strip_path = true
  },
  {
    methods = {"GET", "POST"},
    paths = {"/api/v1/projects"},
    service = "project-service",
    strip_path = true,
    plugins = {"jwt-auth", "rate-limiting"}
  },
  -- ... æ›´å¤šè·¯ç”±
}
```

### è®¤è¯æ’ä»¶ (JWT)

```lua
-- JWTéªŒè¯æ’ä»¶é…ç½®
kong.plugins.jwt = {
  key_claim_name = "sub",
  secret_is_base64 = false,
  algorithm = "HS256",
  validate_exp = true
}

-- ä¸ºå—ä¿æŠ¤çš„è·¯ç”±å¯ç”¨JWT
kong.route_plugins.jwt_auth = {
  methods = {"GET", "POST", "PUT", "DELETE"},
  paths = {
    "/api/v1/projects",
    "/api/v1/users/*",
    "/api/v1/designs/*"
  }
  -- æ’é™¤çš„è·¯ç”±
  skip_paths = {
    "/api/v1/auth/register",
    "/api/v1/auth/login",
    "/api/v1/auth/refresh",
    "/api/v1/share/*"
  }
}
```

### é™æµæ’ä»¶é…ç½®

```yaml
rate-limiting:
  # å…¨å±€é™æµ: æ¯ç§’100è¯·æ±‚
  second: 100

  # æŒ‰ç”¨æˆ·é™æµ
  policy: "redis"
  redis_host: redis.internal
  redis_port: 6379

  # ä¸åŒç«¯ç‚¹çš„é™æµç­–ç•¥
  endpoints:
    /api/v1/designs/generate:
      second: 10      # é˜²æ­¢æ»¥ç”¨
      minute: 100
    /api/v1/exports:
      second: 5
      minute: 50
```

---

## æ•°æ®æ¶æ„

### æ•°æ®åº“ERå›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ email (UNIQUE)  â”‚
â”‚ username        â”‚
â”‚ password_hash   â”‚
â”‚ avatar_url      â”‚
â”‚ subscription    â”‚
â”‚ created_at      â”‚
â”‚ updated_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ projects            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id (PK)             â”‚
    â”‚ user_id (FK)        â”‚
    â”‚ title               â”‚
    â”‚ width, height       â”‚
    â”‚ status              â”‚
    â”‚ created_at          â”‚
    â”‚ updated_at          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ designs             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ id (PK)             â”‚
        â”‚ project_id (FK)     â”‚
        â”‚ version             â”‚
        â”‚ content_title       â”‚
        â”‚ elements (JSON)     â”‚
        â”‚ style_id            â”‚
        â”‚ color_theme         â”‚
        â”‚ created_at          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ exports         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ design_id (FK)  â”‚
â”‚ format          â”‚
â”‚ resolution      â”‚
â”‚ file_path       â”‚
â”‚ file_size       â”‚
â”‚ download_count  â”‚
â”‚ expires_at      â”‚
â”‚ created_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ assets          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ user_id (FK)    â”‚
â”‚ project_id (FK) â”‚
â”‚ type            â”‚
â”‚ file_path       â”‚
â”‚ metadata (JSON) â”‚
â”‚ created_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PostgreSQL å»ºè¡¨è¯­å¥

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  subscription_tier VARCHAR(20) DEFAULT 'free',
  subscription_expiry TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- é¡¹ç›®è¡¨
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  thumbnail_url TEXT,
  canvas_width INT DEFAULT 1080,
  canvas_height INT DEFAULT 1080,
  status VARCHAR(20) DEFAULT 'draft',
  is_template BOOLEAN DEFAULT false,
  is_public BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);

-- è®¾è®¡è¡¨
CREATE TABLE designs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  version INT NOT NULL,
  content_title VARCHAR(255),
  content_subtitle VARCHAR(255),
  content_body TEXT,
  content_cta VARCHAR(100),
  style_id VARCHAR(50),
  color_theme_id VARCHAR(50),
  elements JSONB NOT NULL,
  is_selected BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(project_id, version)
);

CREATE INDEX idx_designs_project_id ON designs(project_id);
CREATE INDEX idx_designs_version ON designs(project_id, version DESC);

-- å¯¼å‡ºè¡¨
CREATE TABLE exports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  design_id UUID NOT NULL REFERENCES designs(id) ON DELETE CASCADE,
  format VARCHAR(20) NOT NULL,
  resolution VARCHAR(20),
  file_path TEXT NOT NULL,
  file_size INT,
  download_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP
);

CREATE INDEX idx_exports_design_id ON exports(design_id);
```

### åˆ†ç‰‡ç­–ç•¥

å¯¹äºè¶…å¤§è§„æ¨¡ï¼ˆ10äº¿+æ¡è®°å½•ï¼‰ï¼š

```
è®¾è®¡è¡¨æŒ‰é¡¹ç›®IDåˆ†ç‰‡:
  projects_designs_1 (user_id hash(1))
  projects_designs_2 (user_id hash(2))
  ...
  projects_designs_N

å¯¼å‡ºè¡¨æŒ‰æ—¥æœŸåˆ†ç‰‡:
  exports_2025_10
  exports_2025_11
  exports_2025_12
```

---

## æ¶ˆæ¯é˜Ÿåˆ—

### RabbitMQæ¶æ„

```yaml
# rabbitmq.conf
cluster_name: pgen-cluster
listeners.ssl.default: 5671
management.tcp.port: 15672

# é˜Ÿåˆ—å®šä¹‰
queues:
  design_generation:
    durable: true
    arguments:
      x-message-ttl: 3600000  # 1å°æ—¶
      x-dead-letter-exchange: design_generation_dlx

  export_task:
    durable: true
    x-max-length: 10000

  email_notification:
    durable: true

# äº¤æ¢æœºå®šä¹‰
exchanges:
  design_events:
    type: topic
    durable: true

  export_events:
    type: topic
    durable: true
```

### å¼‚æ­¥ä»»åŠ¡å·¥ä½œæµ

```
ã€è®¾è®¡ç”Ÿæˆæµç¨‹ã€‘

APIè¯·æ±‚:
  POST /api/v1/designs/generate
  {
    "project_id": "proj_123",
    "style": "modern_business",
    "variant_count": 3
  }
  â†“
å‘é€æ¶ˆæ¯åˆ°RabbitMQ:
  {
    "task_id": "task_abc123",
    "type": "design_generation",
    "payload": { ... },
    "created_at": "2025-10-26T10:00:00Z"
  }
  â†“
ç«‹å³è¿”å›ç»™ç”¨æˆ·:
  {
    "status": "processing",
    "task_id": "task_abc123"
  }
  â†“ (åå°å¼‚æ­¥å¤„ç†)
Workeræ¥æ”¶ä»»åŠ¡:
  â†’ åŠ è½½AIæ¨¡å‹
  â†’ è¿è¡Œæ’ç‰ˆç®—æ³•
  â†’ ç”Ÿæˆå˜ä½“
  â†’ ä¿å­˜åˆ°S3
  â†“
å‘å¸ƒå®Œæˆäº‹ä»¶:
  {
    "event": "design.generated",
    "task_id": "task_abc123",
    "designs": [...]
  }
  â†“
ç”¨æˆ·è½®è¯¢æˆ–WebSocketæ¥æ”¶ç»“æœ
  ç”¨æˆ·: GET /api/v1/tasks/task_abc123
  è¿”å›: { "status": "completed", "designs": [...] }
```

### é”™è¯¯å¤„ç†å’Œé‡è¯•

```
ä»»åŠ¡å¤„ç†å¤±è´¥
  â†“
è‡ªåŠ¨é‡è¯• (æœ€å¤š3æ¬¡)
  â€¢ ç¬¬1æ¬¡: ç«‹å³é‡è¯•
  â€¢ ç¬¬2æ¬¡: 5ç§’å»¶è¿Ÿ
  â€¢ ç¬¬3æ¬¡: 30ç§’å»¶è¿Ÿ
  â†“
ä»ç„¶å¤±è´¥
  â†’ å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— (DLQ)
  â†’ å‘Šè­¦é€šçŸ¥ç®¡ç†å‘˜
  â†’ ç”¨æˆ·æ”¶åˆ°å¤±è´¥é€šçŸ¥
```

---

## ç¼“å­˜ç­–ç•¥

### å¤šå±‚ç¼“å­˜æ¶æ„

```
ç”¨æˆ·è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CDNç¼“å­˜     â”‚ (CloudFlare/Akamai)
â”‚ â€¢ é™æ€èµ„æº  â”‚ TTL: 1å‘¨
â”‚ â€¢ å…¬å¼€é¡¹ç›®  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Cache Miss
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redisç¼“å­˜   â”‚ (åº”ç”¨å±‚ç¼“å­˜)
â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯  â”‚ TTL: 1å°æ—¶
â”‚ â€¢ é¡¹ç›®åˆ—è¡¨  â”‚
â”‚ â€¢ é¢‘ç¹æŸ¥è¯¢  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Cache Miss
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“      â”‚
â”‚ PostgreSQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redisç¼“å­˜é”®è®¾è®¡

```
# ç”¨æˆ·ç›¸å…³
user:{userId}:profile          # ç”¨æˆ·ä¿¡æ¯ (TTL: 1å°æ—¶)
user:{userId}:projects         # ç”¨æˆ·é¡¹ç›®åˆ—è¡¨ (TTL: 10åˆ†é’Ÿ)
user:{userId}:subscription     # è®¢é˜…ä¿¡æ¯ (TTL: 30åˆ†é’Ÿ)

# é¡¹ç›®ç›¸å…³
project:{projectId}:details    # é¡¹ç›®è¯¦æƒ… (TTL: 30åˆ†é’Ÿ)
project:{projectId}:designs    # è®¾è®¡å†å² (TTL: 10åˆ†é’Ÿ)

# è®¾è®¡ç›¸å…³
design:{designId}:content      # è®¾è®¡å†…å®¹ (TTL: 5åˆ†é’Ÿ)

# ä¼šè¯
session:{token}                # ä¼šè¯æ•°æ® (TTL: 7å¤©)

# è®¡æ•°å™¨
stats:user:{userId}:designs    # ç”¨æˆ·è®¾è®¡æ•° (å®æ—¶æ›´æ–°)
stats:daily:exports            # æ—¥å¯¼å‡ºæ•° (æ¯æ—¥é‡ç½®)

# é€Ÿç‡é™åˆ¶
ratelimit:user:{userId}        # ç”¨æˆ·è¯·æ±‚è®¡æ•° (TTL: 60ç§’)
ratelimit:design_gen:{userId}  # ç”Ÿæˆé™æµ (TTL: 60ç§’)
```

### ç¼“å­˜å¤±æ•ˆç­–ç•¥

```
ä¸»åŠ¨å¤±æ•ˆ (æ¨è):
  â€¢ ç”¨æˆ·åˆ›å»ºé¡¹ç›® â†’ æ¸…é™¤ user:{userId}:projects
  â€¢ é¡¹ç›®æ›´æ–° â†’ æ¸…é™¤ project:{projectId}:*

è¢«åŠ¨å¤±æ•ˆ:
  â€¢ è®¾ç½® TTLï¼Œè‡ªåŠ¨è¿‡æœŸ

ç¼“å­˜é¢„çƒ­:
  â€¢ ç”¨æˆ·ç™»å½•æ—¶ï¼Œé¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯å’Œé¡¹ç›®åˆ—è¡¨
  â€¢ é¡¹ç›®æ‰“å¼€æ—¶ï¼Œé¢„åŠ è½½è®¾è®¡å†å²
```

---

## æ–‡ä»¶å­˜å‚¨

### S3å­˜å‚¨ç»“æ„

```
s3://pgen-production/
â”œâ”€â”€ uploads/                    # ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
â”‚   â”œâ”€â”€ {year}/{month}/{day}/
â”‚   â”‚   â”œâ”€â”€ {userId}/
â”‚   â”‚   â”‚   â”œâ”€â”€ image_abc123.jpg
â”‚   â”‚   â”‚   â””â”€â”€ image_def456.png
â”‚   â”‚
â”œâ”€â”€ designs/                    # ç”Ÿæˆçš„è®¾è®¡
â”‚   â”œâ”€â”€ {projectId}/
â”‚   â”‚   â”œâ”€â”€ design_v1.json     # è®¾è®¡æ•°æ®ï¼ˆå¤‡ä»½ï¼‰
â”‚   â”‚   â”œâ”€â”€ preview.jpg        # é¢„è§ˆå›¾
â”‚   â”‚   â””â”€â”€ designs/
â”‚   â”‚       â”œâ”€â”€ variant_1.png
â”‚   â”‚       â”œâ”€â”€ variant_2.png
â”‚   â”‚       â””â”€â”€ variant_3.png
â”‚
â”œâ”€â”€ exports/                    # å¯¼å‡ºçš„æ–‡ä»¶
â”‚   â”œâ”€â”€ {exportId}/
â”‚   â”‚   â”œâ”€â”€ design_20251026_001.png
â”‚   â”‚   â”œâ”€â”€ design_20251026_001.html
â”‚   â”‚   â””â”€â”€ design_20251026_001.pdf
â”‚
â”œâ”€â”€ assets/                     # ç³»ç»Ÿç´ æåº“
â”‚   â”œâ”€â”€ icons/
â”‚   â”œâ”€â”€ backgrounds/
â”‚   â””â”€â”€ fonts/
â”‚
â””â”€â”€ public/                     # å…¬å¼€èµ„æºï¼ˆCDNåŠ é€Ÿï¼‰
    â”œâ”€â”€ styles.css
    â”œâ”€â”€ scripts.js
    â””â”€â”€ images/
```

### æ–‡ä»¶å®‰å…¨ç­–ç•¥

```yaml
# S3è®¿é—®æ§åˆ¶
- æ‰€æœ‰æ–‡ä»¶åŠ å¯†å­˜å‚¨ (AES-256)
- ç§æœ‰æ–‡ä»¶: ACLè®¾ç½®ä¸ºprivate
- å…¬å¼€èµ„æº: é€šè¿‡CloudFront CDNè®¿é—®
- ç­¾åURL: å¯¼å‡ºæ–‡ä»¶æœ‰24å°æ—¶è¿‡æœŸæ—¶é—´

# ç—…æ¯’æ‰«æ
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶æµç¨‹:
  1. æ¥æ”¶æ–‡ä»¶
  2. ç—…æ¯’æ‰«æ (ClamAV)
  3. é€šè¿‡åä¸Šä¼ åˆ°S3
  4. æ›´æ–°æ•°æ®åº“

# è®¿é—®æ—¥å¿—
- å¯ç”¨S3è®¿é—®æ—¥å¿—
- å®šæœŸå®¡è®¡æ–‡ä»¶è®¿é—®
```

---

## éƒ¨ç½²æ¶æ„

### Kubernetesé…ç½®

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: project-service
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: project-service
  template:
    metadata:
      labels:
        app: project-service
        version: v1.0.0
    spec:
      containers:
      - name: project-service
        image: registry.example.com/project-service:v1.0.0
        ports:
        - containerPort: 3002
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: postgres-url
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: redis-url
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3002
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3002
          initialDelaySeconds: 5
          periodSeconds: 5

# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: project-service
spec:
  selector:
    app: project-service
  ports:
  - port: 3002
    targetPort: 3002
  type: ClusterIP

# hpa.yaml - è‡ªåŠ¨ä¼¸ç¼©
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: project-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: project-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### CI/CDæµç¨‹

```yaml
# .gitlab-ci.yml - Python FastAPI ç‰ˆæœ¬
stages:
  - test
  - build
  - deploy

variables:
  REGISTRY: registry.example.com
  IMAGE_NAME: pgen-service
  PYTHON_VERSION: "3.11"

test:
  stage: test
  image: python:3.11-slim
  script:
    # å®‰è£…ä¾èµ–
    - pip install poetry
    - poetry install

    # è¿è¡Œæµ‹è¯•
    - poetry run pytest tests/ --cov=app --cov-report=xml
    - poetry run pytest tests/ --cov=app --cov-report=term

    # ä»£ç è´¨é‡æ£€æŸ¥
    - poetry run black --check app/
    - poetry run ruff check app/
    - poetry run mypy app/

  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    # æ„å»ºé•œåƒ
    - docker build
        -t $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
        -t $REGISTRY/$IMAGE_NAME:latest
        .

    # æ¨é€åˆ°é•œåƒä»“åº“
    - docker push $REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
    - docker push $REGISTRY/$IMAGE_NAME:latest

  only:
    - main
    - develop

deploy_staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # æ›´æ–°é•œåƒ
    - kubectl set image deployment/project-service
        project-service=$REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
        -n staging

    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/project-service -n staging --timeout=5m

  environment:
    name: staging
    kubernetes:
      namespace: staging
  only:
    - develop

deploy_production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    # æ›´æ–°é•œåƒ
    - kubectl set image deployment/project-service
        project-service=$REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
        -n production

    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/project-service -n production --timeout=5m

  environment:
    name: production
    kubernetes:
      namespace: production
  only:
    - main
  when: manual
```

**æœ¬åœ°å¼€å‘å·¥ä½œæµ**:
```bash
# ä½¿ç”¨Poetryç®¡ç†ä¾èµ–
poetry install

# è¿è¡Œå¼€å‘æœåŠ¡å™¨ (è‡ªåŠ¨é‡è½½)
poetry run uvicorn app.main:app --reload --port 3002

# è¿è¡Œæµ‹è¯•
poetry run pytest tests/ -v

# è¿è¡Œä»£ç æ£€æŸ¥
poetry run black app/
poetry run ruff check app/
poetry run mypy app/

# ç”ŸæˆAPIæ–‡æ¡£
# è‡ªåŠ¨ç”Ÿæˆ: http://localhost:3002/docs (Swagger UI)
# æˆ–è®¿é—®: http://localhost:3002/redoc (ReDoc)
```

---

## ç›‘æ§å‘Šè­¦

### PrometheusæŒ‡æ ‡

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'project-service'
    static_configs:
      - targets: ['localhost:3002']
    metrics_path: '/metrics'

# å…³é”®æŒ‡æ ‡
application_requests_total:
  type: Counter
  help: æ€»è¯·æ±‚æ•°
  labels: [method, endpoint, status]

application_request_duration_ms:
  type: Histogram
  help: è¯·æ±‚è€—æ—¶
  buckets: [10, 50, 100, 500, 1000]
  labels: [method, endpoint]

database_query_duration_ms:
  type: Histogram
  help: æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
  labels: [query_type]

cache_hits_total:
  type: Counter
  help: ç¼“å­˜å‘½ä¸­æ•°
  labels: [cache_type]

design_generation_duration_ms:
  type: Histogram
  help: è®¾è®¡ç”Ÿæˆè€—æ—¶
  labels: [style]

export_duration_ms:
  type: Histogram
  help: å¯¼å‡ºè€—æ—¶
  labels: [format]
```

### å‘Šè­¦è§„åˆ™

```yaml
# alert.rules.yml
groups:
  - name: application
    rules:
    - alert: HighErrorRate
      expr: rate(application_requests_total{status="500"}[5m]) > 0.05
      for: 5m
      annotations:
        summary: "é«˜é”™è¯¯ç‡å‘Šè­¦"

    - alert: SlowResponse
      expr: histogram_quantile(0.95, application_request_duration_ms) > 1000
      for: 10m
      annotations:
        summary: "å“åº”æ—¶é—´è¿‡é•¿"

    - alert: DatabaseConnectionPool
      expr: database_connections_active > 80
      for: 5m
      annotations:
        summary: "æ•°æ®åº“è¿æ¥æ± å‘Šæ€¥"

    - alert: DesignGenerationTimeout
      expr: rate(design_generation_timeout_total[5m]) > 0.1
      for: 5m
      annotations:
        summary: "è®¾è®¡ç”Ÿæˆè¶…æ—¶ç‡é«˜"
```

### æ—¥å¿—èšåˆ (ELK Stack)

```yaml
# logstash é…ç½®
input {
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  if [type] == "application" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:logger} %{GREEDYDATA:message}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
  }
}

# Kibana dashboards
- Request Rate Over Time
- Error Rate by Service
- Response Time Distribution
- Database Query Performance
- Cache Hit Rate
```

---

## å®‰å…¨è®¾è®¡

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç™»å½•                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  1. ç”¨æˆ·è¾“å…¥é‚®ç®±/å¯†ç                               â”‚
â”‚     POST /api/v1/auth/login                        â”‚
â”‚     {                                              â”‚
â”‚       "email": "user@example.com",                â”‚
â”‚       "password": "***"                           â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â”‚  2. æœåŠ¡å™¨éªŒè¯                                     â”‚
â”‚     â€¢ æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“                              â”‚
â”‚     â€¢ ä½¿ç”¨bcryptéªŒè¯å¯†ç                           â”‚
â”‚     â€¢ æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®š                          â”‚
â”‚                                                     â”‚
â”‚  3. ç”ŸæˆToken                                      â”‚
â”‚     JWT = Header.Payload.Signature                â”‚
â”‚                                                     â”‚
â”‚     Header: {                                       â”‚
â”‚       "alg": "HS256",                              â”‚
â”‚       "typ": "JWT"                                 â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â”‚     Payload: {                                      â”‚
â”‚       "sub": "user_123",          # ç”¨æˆ·ID        â”‚
â”‚       "email": "user@example.com",                â”‚
â”‚       "role": "user",                              â”‚
â”‚       "iat": 1698259200,          # å‘è¡Œæ—¶é—´      â”‚
â”‚       "exp": 1698345600,          # è¿‡æœŸæ—¶é—´(1å¤©) â”‚
â”‚       "jti": "unique_token_id"    # Token ID      â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â”‚  4. è¿”å›Token                                      â”‚
â”‚     HTTP 200 OK                                    â”‚
â”‚     {                                              â”‚
â”‚       "access_token": "eyJhbGc...",              â”‚
â”‚       "refresh_token": "eyJhbGc...",             â”‚
â”‚       "expires_in": 86400                         â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â”‚  5. å°†Tokenå­˜å‚¨åœ¨æµè§ˆå™¨                           â”‚
â”‚     â€¢ Access Token: å†…å­˜ (æ˜“äºXSSæ”»å‡»ä½†å®‰å…¨)     â”‚
â”‚     â€¢ Refresh Token: HttpOnly Cookie (CSRFé˜²æŠ¤)  â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tokenåˆ·æ–°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tokenå³å°†è¿‡æœŸ (< 1å¤©)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  1. å®¢æˆ·ç«¯è‡ªåŠ¨åˆ·æ–°                                 â”‚
â”‚     POST /api/v1/auth/refresh                      â”‚
â”‚     {                                              â”‚
â”‚       "refresh_token": "..."                       â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â”‚  2. æœåŠ¡å™¨éªŒè¯Refresh Token                        â”‚
â”‚     â€¢ æ£€æŸ¥ç­¾åæœ‰æ•ˆæ€§                              â”‚
â”‚     â€¢ æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­ (Redis)                 â”‚
â”‚     â€¢ æ£€æŸ¥è¿‡æœŸæ—¶é—´                                â”‚
â”‚                                                     â”‚
â”‚  3. ç”Ÿæˆæ–°çš„Access Token                          â”‚
â”‚     â€¢ æ–°çš„ exp æ—¶é—´                               â”‚
â”‚     â€¢ ä¿ç•™åŸæœ‰çš„ sub, roleç­‰ä¿¡æ¯                  â”‚
â”‚                                                     â”‚
â”‚  4. è¿”å›æ–°Token                                    â”‚
â”‚     HTTP 200 OK                                    â”‚
â”‚     {                                              â”‚
â”‚       "access_token": "new_token...",            â”‚
â”‚       "expires_in": 86400                         â”‚
â”‚     }                                              â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒé™æ§åˆ¶ (RBAC)

```yaml
# è§’è‰²å®šä¹‰
roles:
  admin:
    - projects:*
    - users:*
    - settings:*
    - analytics:*

  user:
    - projects:create
    - projects:read (own)
    - projects:update (own)
    - projects:delete (own)
    - designs:*
    - exports:*

  viewer:
    - projects:read (shared)
    - designs:read (shared)
    - exports:download (shared)

# æƒé™æ£€æŸ¥ä¸­é—´ä»¶
@require_permission('projects:update')
def update_project(project_id):
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºé¡¹ç›®æ‰€æœ‰è€…
    if current_user.id != project.user_id:
        raise ForbiddenError()
```

### APIå®‰å…¨é˜²æŠ¤

```
ã€DDoSé˜²æŠ¤ã€‘
1. é€Ÿç‡é™åˆ¶ (Kong)
   â€¢ å…¨å±€: 100 req/s
   â€¢ ç”¨æˆ·: 10 req/s
   â€¢ IP: 1000 req/s

2. è¿æ¥é™åˆ¶
   â€¢ å•IPæœ€å¤š100ä¸ªå¹¶å‘è¿æ¥

3. è¯·æ±‚è¶…æ—¶
   â€¢ è¯»è¶…æ—¶: 30ç§’
   â€¢ å†™è¶…æ—¶: 60ç§’

ã€SQLæ³¨å…¥é˜²æŠ¤ã€‘
â€¢ ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ (ORM)
â€¢ è¾“å…¥éªŒè¯å’Œæ¸…ç†
â€¢ SQLè¯­å¥ç™½åå•

ã€CORSé˜²æŠ¤ã€‘
Access-Control-Allow-Origin: https://app.example.com
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Max-Age: 86400

ã€CSRFé˜²æŠ¤ã€‘
â€¢ Refresh Tokenå­˜åœ¨HttpOnly Cookieä¸­
â€¢ æ¯ä¸ªçŠ¶æ€æ”¹å˜æ“ä½œéœ€è¦æœ‰æ•ˆçš„CSRF Token

ã€XSSé˜²æŠ¤ã€‘
â€¢ å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
  Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'
â€¢ è¾“å‡ºè½¬ä¹‰
â€¢ é¿å…ä½¿ç”¨ eval()
```

---

## æˆæœ¬ä¼°ç®— (å¹´åº¦)

### äº‘èµ„æºæˆæœ¬

```
AWS Services:
â”œâ”€ EC2 (KubernetesèŠ‚ç‚¹)
â”‚  â”œâ”€ 3 * t3.xlarge (ä¸») = $3,200/æœˆ
â”‚  â”œâ”€ 2 * t3.large (ç¼“å­˜) = $960/æœˆ
â”‚  â””â”€ 1 * t3.large (æ•°æ®åº“) = $480/æœˆ
â”‚
â”œâ”€ RDS PostgreSQL
â”‚  â””â”€ db.r6i.xlarge (12TBå­˜å‚¨) = $2,500/æœˆ
â”‚
â”œâ”€ ElastiCache Redis
â”‚  â””â”€ cache.r6g.xlarge = $1,200/æœˆ
â”‚
â”œâ”€ S3å­˜å‚¨
â”‚  â””â”€ 10TBå­˜å‚¨ + å‡ºç«™æµé‡ = $2,000/æœˆ
â”‚
â”œâ”€ CloudFront CDN
â”‚  â””â”€ 100TBæœˆå‡ºç«™æµé‡ = $3,000/æœˆ
â”‚
â”œâ”€ RabbitMQ (æ‰˜ç®¡)
â”‚  â””â”€ æ ‡å‡†é…ç½® = $500/æœˆ
â”‚
â”œâ”€ æ•°æ®ä¼ è¾“
â”‚  â””â”€ è·¨AZ/è·¨åœ°åŸŸ = $1,000/æœˆ
â”‚
â””â”€ å…¶ä»– (ç›‘æ§ã€å¤‡ä»½ç­‰)
   â””â”€ = $1,000/æœˆ

æ€»è®¡: ~$15,840/æœˆ = $190,000/å¹´

ä¼˜åŒ–æ–¹å‘:
- ä½¿ç”¨Spotå®ä¾‹çœ30-70%
- Reserved Instanceé•¿æœŸä¼˜æƒ 
- è‡ªå»ºæ•°æ®åº“æœºæˆ¿
```

---

## Python FastAPI æŠ€æœ¯æ ˆä¼˜åŠ¿æ€»ç»“

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | FastAPI | Express.js |
|------|---------|-----------|
| å•å®ä¾‹ååé‡ | ~10,000 req/s | ~8,000 req/s |
| P95å»¶è¿Ÿ | <50ms | <60ms |
| å†…å­˜å ç”¨ | 50-100MB | 80-150MB |
| å†·å¯åŠ¨æ—¶é—´ | 1-2s | 0.5-1s |

### FastAPI æ ¸å¿ƒä¼˜åŠ¿

1. **åŸç”Ÿå¼‚æ­¥æ”¯æŒ** - åŸºäº asyncioï¼Œå¤©ç”Ÿæ”¯æŒé«˜å¹¶å‘
2. **è‡ªåŠ¨APIæ–‡æ¡£** - OpenAPI/Swagger è‡ªåŠ¨ç”Ÿæˆ
3. **æ•°æ®éªŒè¯** - Pydantic V2 å¼ºå¤§çš„ç±»å‹æ£€æŸ¥
4. **å¼€å‘æ•ˆç‡** - ä»£ç ç®€æ´ï¼Œç±»å‹æç¤ºå‹å¥½
5. **ç”Ÿæ€å®Œæ•´** - ä¸°å¯Œçš„æ‰©å±•åº“ç”Ÿæ€

### ä¾èµ–åº“ç‰ˆæœ¬è¦æ±‚

```
Python >= 3.11
FastAPI >= 0.104.0
SQLAlchemy >= 2.0.23
asyncpg >= 0.29.0  (PostgreSQL å¼‚æ­¥é©±åŠ¨)
Pydantic >= 2.5.0
PyJWT >= 2.8.1
passlib >= 1.7.4
python-multipart >= 0.0.6
redis >= 5.0.1
celery >= 5.3.4
aioredis >= 2.0.1
boto3 >= 1.28.0
```

### é¡¹ç›®ç»“æ„èŒƒä¾‹

```
project-service/
â”œâ”€â”€ pyproject.toml          # Poetry é…ç½®
â”œâ”€â”€ Dockerfile              # å®¹å™¨é•œåƒ
â”œâ”€â”€ docker-compose.yml      # æœ¬åœ°å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ Makefile                # å¼€å‘å‘½ä»¤
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py             # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models/             # SQLAlchemy ORM æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ project.py
â”‚   â”‚   â””â”€â”€ design.py
â”‚   â”œâ”€â”€ schemas/            # Pydantic æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â””â”€â”€ project.py
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ endpoints/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ users.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ projects.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ designs.py
â”‚   â”‚   â”‚   â””â”€â”€ dependencies.py
â”‚   â”‚   â””â”€â”€ api.py
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ base.py         # Base SQLAlchemy Model
â”‚   â”‚   â”œâ”€â”€ session.py      # æ•°æ®åº“ä¼šè¯é…ç½®
â”‚   â”‚   â””â”€â”€ crud.py         # é€šç”¨ CRUD æ“ä½œ
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”œâ”€â”€ project_service.py
â”‚   â”‚   â””â”€â”€ design_service.py
â”‚   â”œâ”€â”€ tasks/              # Celery å¼‚æ­¥ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ celery_app.py
â”‚   â”‚   â””â”€â”€ design_tasks.py
â”‚   â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ jwt.py          # JWT å¤„ç†
â”‚   â”‚   â”œâ”€â”€ s3.py           # S3 æ“ä½œ
â”‚   â”‚   â””â”€â”€ cache.py        # Redis ç¼“å­˜
â”‚   â””â”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ auth.py
â”‚       â””â”€â”€ error_handler.py
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py
â”‚   â”œâ”€â”€ test_users.py
â”‚   â”œâ”€â”€ test_projects.py
â”‚   â””â”€â”€ test_designs.py
â”œâ”€â”€ migrations/             # Alembic æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ alembic.ini
â”‚   â””â”€â”€ versions/
â””â”€â”€ scripts/               # è¾…åŠ©è„šæœ¬
    â””â”€â”€ init_db.py
```

### å¼€å‘æŒ‡å—

**1. æœ¬åœ°ç¯å¢ƒæ­å»º**
```bash
# å…‹éš†é¡¹ç›®
git clone <repo>
cd project-service

# å®‰è£… Poetry
curl -sSL https://install.python-poetry.org | python3 -

# å®‰è£…ä¾èµ–
poetry install

# å¯åŠ¨æœ¬åœ°æ•°æ®åº“ (Docker Compose)
docker-compose up -d

# åˆå§‹åŒ–æ•°æ®åº“
poetry run python scripts/init_db.py

# è¿è¡Œåº”ç”¨
poetry run uvicorn app.main:app --reload --port 3002
```

**2. å¼€å‘å·¥ä½œæµ**
```bash
# åˆ›å»ºç‰¹æ€§åˆ†æ”¯
git checkout -b feature/new-feature

# ç¼–å†™ä»£ç  (å¯ç”¨è‡ªåŠ¨æ ¼å¼åŒ–)
poetry run black app/

# è¿è¡Œæµ‹è¯•
poetry run pytest tests/ -v

# æäº¤ä»£ç 
git commit -m "feat: new feature"

# æ¨é€å¹¶åˆ›å»º PR
git push origin feature/new-feature
```

**3. éƒ¨ç½²æµç¨‹**
- GitLab CI/CD è‡ªåŠ¨è§¦å‘
- è¿è¡Œæµ‹è¯•å’Œä»£ç æ£€æŸ¥
- æ„å»º Docker é•œåƒ
- æ¨é€åˆ°é•œåƒä»“åº“
- è‡ªåŠ¨éƒ¨ç½²åˆ° staging ç¯å¢ƒ
- æ‰‹åŠ¨ç¡®è®¤éƒ¨ç½²åˆ° production

---

**åç«¯ç³»ç»Ÿæ¶æ„è®¾è®¡å®Œæˆï¼** âœ…

**æŠ€æœ¯æ ˆè½¬æ¢**: Node.js/Express â†’ Python 3.11/FastAPI âœ¨
**ç‰ˆæœ¬**: V2.0 (2025-10-26)

ä¸‹ä¸€æ­¥å°†æ›´æ–°ç³»ç»Ÿæ¶æ„æ€»ç»“å’Œå‰åç«¯äº¤äº’è®¾è®¡ã€‚
