# æ™ºç»˜æµ·æŠ¥é¡¹ç›® - å‰åç«¯ååŒå¼€å‘è§„èŒƒ

**ç‰ˆæœ¬**: V1.0
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ26æ—¥
**é€‚ç”¨èŒƒå›´**: MVPé˜¶æ®µ â†’ Phase 3
**æŠ€æœ¯æ ˆ**:
- **åç«¯**: Python 3.11 + FastAPI 0.104+ + Pydantic 2.5+
- **å‰ç«¯**: Vue 3.4+ + TypeScript 5.0+ + Pinia 2.x

---

## ğŸ“‹ ç›®å½•

1. [API å¥‘çº¦å¼€å‘æµç¨‹](#api-å¥‘çº¦å¼€å‘æµç¨‹)
2. [Mock Server æ­å»º](#mock-server-æ­å»º)
3. [æ•°æ®æ¨¡å‹åŒæ­¥æœºåˆ¶](#æ•°æ®æ¨¡å‹åŒæ­¥æœºåˆ¶)
4. [å®æ—¶åä½œæœºåˆ¶](#å®æ—¶åä½œæœºåˆ¶)
5. [å‰åç«¯å¹¶è¡Œå¼€å‘æœ€ä½³å®è·µ](#å‰åç«¯å¹¶è¡Œå¼€å‘æœ€ä½³å®è·µ)

---

## API å¥‘çº¦å¼€å‘æµç¨‹

### å¥‘çº¦ä¼˜å…ˆå¼€å‘åŸåˆ™

**ä¸ºä»€ä¹ˆè¦å¥‘çº¦ä¼˜å…ˆ**:
- âœ… **å‰åç«¯å¹¶è¡Œå¼€å‘**: å‰ç«¯ä¸ä¾èµ–åç«¯å®ç°,åŸºäºå¥‘çº¦è¿›è¡Œ Mock å¼€å‘
- âœ… **å‡å°‘è¿”å·¥**: æå‰ç¡®å®šæ¥å£å®šä¹‰,é¿å…åæœŸé¢‘ç¹ä¿®æ”¹
- âœ… **æ¸…æ™°çš„æ¥å£å®šä¹‰**: ç»Ÿä¸€çš„æ•°æ®æ ¼å¼å’Œé”™è¯¯å¤„ç†è§„èŒƒ
- âœ… **è‡ªåŠ¨åŒ–æ–‡æ¡£**: OpenAPI è§„èŒƒè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
- âœ… **ç±»å‹å®‰å…¨**: ä»å¥‘çº¦ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰

### å¥‘çº¦ä¼˜å…ˆå¼€å‘æµç¨‹å›¾

```mermaid
flowchart TD
    A[äº§å“éœ€æ±‚ PRD] --> B[åç«¯è®¾è®¡ API ç«¯ç‚¹]
    B --> C[åç«¯å®šä¹‰ Pydantic Schema]
    C --> D[åç«¯ç¼–å†™ OpenAPI YAML]
    D --> E[å‰ç«¯è¯„å®¡ API å¥‘çº¦]
    E --> F{å¥‘çº¦ç¡®è®¤?}
    F -->|éœ€ä¿®æ”¹| C
    F -->|ç¡®è®¤| G[é”å®šå¥‘çº¦ç‰ˆæœ¬]
    G --> H[åç«¯å¼€å‘ API å®ç°]
    G --> I[å‰ç«¯å¯åŠ¨ Mock Server]
    I --> J[å‰ç«¯åŸºäº Mock å¼€å‘ UI]
    H --> K[åç«¯å®Œæˆå¹¶æš´éœ² OpenAPI]
    J --> L[å‰ç«¯ç”Ÿæˆ TypeScript ç±»å‹]
    K --> M[è”è°ƒæµ‹è¯•]
    L --> M
    M --> N{æµ‹è¯•é€šè¿‡?}
    N -->|å¤±è´¥| O[ä¿®å¤é—®é¢˜]
    O --> M
    N -->|é€šè¿‡| P[éƒ¨ç½²å‘å¸ƒ]
```

### å¥‘çº¦å®šä¹‰è´£ä»»äºº

| èŒè´£ | è´Ÿè´£äºº | å·¥ä½œå†…å®¹ |
|------|--------|----------|
| **å¥‘çº¦è®¾è®¡** | åç«¯ä¸»å¯¼ | å®šä¹‰ API ç«¯ç‚¹ã€è¯·æ±‚/å“åº” Schemaã€é”™è¯¯ç  |
| **å¥‘çº¦è¯„å®¡** | å‰ç«¯å‚ä¸ | å®¡æŸ¥æ•°æ®ç»“æ„ã€å­—æ®µå‘½åã€ä¸šåŠ¡é€»è¾‘åˆç†æ€§ |
| **å¥‘çº¦ç¡®è®¤** | å‰åç«¯å…±åŒ | åŒæ–¹ç­¾å­—ç¡®è®¤,é”å®šç‰ˆæœ¬ |
| **å¥‘çº¦ç»´æŠ¤** | åç«¯ä¸»å¯¼ | é€šè¿‡ Pull Request å®¡æŸ¥å˜æ›´,ç‰ˆæœ¬é€’å¢ |

---

### OpenAPI è§„èŒƒå®šä¹‰æµç¨‹

#### å·¥ï¿½ï¿½é€‰æ‹©

**æ¨èå·¥å…·**:
1. **Swagger Editor** - åœ¨çº¿ OpenAPI ç¼–è¾‘å™¨ (https://editor.swagger.io)
2. **Stoplight Studio** - æœ¬åœ° OpenAPI è®¾è®¡å·¥å…· (å¯è§†åŒ–ç•Œé¢)
3. **VSCode OpenAPI æ’ä»¶** - `openapi-lint` + `openapi-preview`

**è§„èŒƒç‰ˆæœ¬**: OpenAPI 3.0.3 (æ¨è) æˆ– 3.1.0

#### æ–‡ä»¶ç»„ç»‡ç»“æ„

```
backend/api-specs/
â”œâ”€â”€ openapi.yaml                  # ä¸»æ–‡ä»¶
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ schemas/                  # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ User.yaml
â”‚   â”‚   â”œâ”€â”€ Project.yaml
â”‚   â”‚   â”œâ”€â”€ Design.yaml
â”‚   â”‚   â”œâ”€â”€ Export.yaml
â”‚   â”‚   â””â”€â”€ Error.yaml
â”‚   â”œâ”€â”€ responses/                # å“åº”å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ErrorResponses.yaml
â”‚   â”‚   â””â”€â”€ SuccessResponses.yaml
â”‚   â”œâ”€â”€ parameters/               # å‚æ•°å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ PathParams.yaml
â”‚   â”‚   â””â”€â”€ QueryParams.yaml
â”‚   â”œâ”€â”€ requestBodies/            # è¯·æ±‚ä½“å®šä¹‰
â”‚   â”‚   â””â”€â”€ RequestBodies.yaml
â”‚   â””â”€â”€ securitySchemes/          # å®‰å…¨æ–¹æ¡ˆ
â”‚       â””â”€â”€ JWT.yaml
â””â”€â”€ paths/                        # API è·¯å¾„å®šä¹‰
    â”œâ”€â”€ auth.yaml                 # è®¤è¯ API
    â”œâ”€â”€ users.yaml                # ç”¨æˆ· API
    â”œâ”€â”€ projects.yaml             # é¡¹ç›® API
    â”œâ”€â”€ designs.yaml              # è®¾è®¡ API
    â””â”€â”€ exports.yaml              # å¯¼å‡º API
```

#### å¥‘çº¦å®šä¹‰æ­¥éª¤

**Step 1: äº§å“/åç«¯å®šä¹‰ API ç«¯ç‚¹**

åŸºäºç”¨æˆ·æ•…äº‹,å®šä¹‰éœ€è¦çš„ API ç«¯ç‚¹:

```yaml
# paths/projects.yaml
paths:
  /api/v1/projects:
    get:
      summary: è·å–é¡¹ç›®åˆ—è¡¨
      description: åˆ†é¡µè·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®
      operationId: listProjects
      tags:
        - Projects
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: æˆåŠŸè¿”å›é¡¹ç›®åˆ—è¡¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      summary: åˆ›å»ºé¡¹ç›®
      description: åˆ›å»ºæ–°çš„è®¾è®¡é¡¹ç›®
      operationId: createProject
      tags:
        - Projects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '201':
          description: é¡¹ç›®åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
```

**Step 2: åç«¯å®šä¹‰ Pydantic æ¨¡å‹**

```python
# backend/app/schemas/project.py
from pydantic import BaseModel, Field, constr
from typing import Optional
from datetime import datetime
from uuid import UUID

class ProjectCreate(BaseModel):
    """åˆ›å»ºé¡¹ç›®è¯·æ±‚æ¨¡å‹"""
    title: constr(min_length=1, max_length=255) = Field(..., description="é¡¹ç›®æ ‡é¢˜")
    description: Optional[str] = Field(None, max_length=1000, description="é¡¹ç›®æè¿°")
    canvas_width: int = Field(1080, ge=100, le=10000, description="ç”»å¸ƒå®½åº¦")
    canvas_height: int = Field(1080, ge=100, le=10000, description="ç”»å¸ƒé«˜åº¦")

    class Config:
        json_schema_extra = {
            "example": {
                "title": "åŒ11å¤§ä¿ƒæµ·æŠ¥",
                "description": "ç”µå•†ä¿ƒé”€æ´»åŠ¨æµ·æŠ¥",
                "canvas_width": 1080,
                "canvas_height": 1080
            }
        }

class ProjectResponse(BaseModel):
    """é¡¹ç›®å“åº”æ¨¡å‹"""
    id: UUID
    user_id: UUID
    title: str
    description: Optional[str]
    canvas_width: int
    canvas_height: int
    thumbnail_url: Optional[str]
    status: str  # draft, published, archived
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True  # æ”¯æŒ ORM æ¨¡å‹è½¬æ¢
```

**Step 3: åç«¯ç¼–å†™ OpenAPI YAML è§„èŒƒ**

```yaml
# components/schemas/Project.yaml
ProjectCreate:
  type: object
  required:
    - title
  properties:
    title:
      type: string
      minLength: 1
      maxLength: 255
      description: é¡¹ç›®æ ‡é¢˜
    description:
      type: string
      maxLength: 1000
      description: é¡¹ç›®æè¿°
    canvas_width:
      type: integer
      minimum: 100
      maximum: 10000
      default: 1080
      description: ç”»å¸ƒå®½åº¦
    canvas_height:
      type: integer
      minimum: 100
      maximum: 10000
      default: 1080
      description: ç”»å¸ƒé«˜åº¦
  example:
    title: "åŒ11å¤§ä¿ƒæµ·æŠ¥"
    description: "ç”µå•†ä¿ƒé”€æ´»åŠ¨æµ·æŠ¥"
    canvas_width: 1080
    canvas_height: 1080

ProjectResponse:
  type: object
  properties:
    id:
      type: string
      format: uuid
    user_id:
      type: string
      format: uuid
    title:
      type: string
    description:
      type: string
      nullable: true
    canvas_width:
      type: integer
    canvas_height:
      type: integer
    thumbnail_url:
      type: string
      format: uri
      nullable: true
    status:
      type: string
      enum: [draft, published, archived]
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time
  example:
    id: "123e4567-e89b-12d3-a456-426614174000"
    user_id: "987e6543-e21c-12d3-a456-426614174000"
    title: "åŒ11å¤§ä¿ƒæµ·æŠ¥"
    description: "ç”µå•†ä¿ƒé”€æ´»åŠ¨æµ·æŠ¥"
    canvas_width: 1080
    canvas_height: 1080
    thumbnail_url: "https://cdn.example.com/thumbnails/proj_123.jpg"
    status: "draft"
    created_at: "2025-10-26T10:00:00Z"
    updated_at: "2025-10-26T10:00:00Z"
```

**Step 4: å‰ç«¯è¯„å®¡ API å¥‘çº¦**

å‰ç«¯å¼€å‘è€…å®¡æŸ¥å¥‘çº¦,æå‡ºä¿®æ”¹å»ºè®®:

```yaml
# å¥‘çº¦è¯„å®¡æ¸…å•
- [ ] API è·¯å¾„å‘½åç¬¦åˆ RESTful è§„èŒƒ (GET /projects, POST /projects, PUT /projects/{id})
- [ ] HTTP æ–¹æ³•ä½¿ç”¨æ­£ç¡® (GET æŸ¥è¯¢, POST åˆ›å»º, PUT æ›´æ–°, DELETE åˆ é™¤, PATCH éƒ¨åˆ†æ›´æ–°)
- [ ] è¯·æ±‚ Schema å®Œæ•´ä¸”æœ‰ç¤ºä¾‹ (example å­—æ®µ)
- [ ] å“åº” Schema å®Œæ•´ä¸”æœ‰ç¤ºä¾‹
- [ ] é”™è¯¯å“åº”å®šä¹‰æ¸…æ™° (400/401/403/404/500)
- [ ] åˆ†é¡µ/æ’åº/ç­›é€‰å‚æ•°ç»Ÿä¸€ (page, limit, sort, filter)
- [ ] è®¤è¯æ–¹æ¡ˆå®šä¹‰æ˜ç¡® (JWT Bearer Token)
- [ ] API ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥æ¸…æ™° (/api/v1/)
- [ ] å­—æ®µå‘½åä¸€è‡´ (snake_case æˆ– camelCase,ç»Ÿä¸€é£æ ¼)
- [ ] æ•°æ®ç±»å‹æ­£ç¡® (string, integer, boolean, date-time, uuid)
```

**Step 5: åŒæ–¹ç¡®è®¤å¹¶é”å®šå¥‘çº¦ç‰ˆæœ¬**

```bash
# ä½¿ç”¨ Git Tag é”å®šå¥‘çº¦ç‰ˆæœ¬
git tag -a api-spec-v1.0.0 -m "API å¥‘çº¦ v1.0.0 (MVP é˜¶æ®µ)"
git push origin api-spec-v1.0.0
```

**Step 6: å¥‘çº¦å˜æ›´ç®¡ç†**

æ‰€æœ‰å¥‘çº¦å˜æ›´å¿…é¡»é€šè¿‡ Pull Request å®¡æŸ¥:

```yaml
# Pull Request æ¨¡æ¿: API å¥‘çº¦å˜æ›´
## å˜æ›´åŸå› 
è¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦å˜æ›´ API å¥‘çº¦

## å˜æ›´å†…å®¹
- æ–°å¢ç«¯ç‚¹: POST /api/v1/designs/batch-generate
- ä¿®æ”¹å­—æ®µ: project.canvas_width (int â†’ float)
- åˆ é™¤å­—æ®µ: (æ— )

## å½±å“è¯„ä¼°
- [ ] æ˜¯å¦ä¸ºç ´åæ€§å˜æ›´ (éœ€è¦å‰ç«¯ä¿®æ”¹)
- [ ] æ˜¯å¦éœ€è¦ç‰ˆæœ¬é€’å¢ (v1 â†’ v2)
- [ ] æ˜¯å¦éœ€è¦æ•°æ®åº“è¿ç§»

## æµ‹è¯•éªŒè¯
- [ ] åç«¯å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯ Mock æµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
```

---

### ä» Pydantic æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆ OpenAPI

**FastAPI è‡ªåŠ¨ç”Ÿæˆ OpenAPI è§„èŒƒ**:

FastAPI å†…ç½®äº† OpenAPI è‡ªåŠ¨ç”ŸæˆåŠŸèƒ½,åŸºäº Pydantic æ¨¡å‹è‡ªåŠ¨æ¨å¯¼ Schemaã€‚

```python
# backend/app/main.py
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI(
    title="AI PosterGen API",
    description="æ™ºç»˜æµ·æŠ¥ - AI æµ·æŠ¥ç”Ÿæˆå¹³å° API",
    version="1.0.0",
    openapi_url="/api/v1/openapi.json",  # OpenAPI JSON ç«¯ç‚¹
    docs_url="/api/v1/docs",              # Swagger UI
    redoc_url="/api/v1/redoc"             # ReDoc
)

# è‡ªå®šä¹‰ OpenAPI Schema
def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title=app.title,
        version=app.version,
        description=app.description,
        routes=app.routes,
    )

    # æ·»åŠ å®‰å…¨æ–¹æ¡ˆ
    openapi_schema["components"]["securitySchemes"] = {
        "BearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT"
        }
    }

    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi

# API ç«¯ç‚¹å®šä¹‰
@app.post("/api/v1/projects", response_model=ProjectResponse, status_code=201)
async def create_project(
    project_in: ProjectCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    åˆ›å»ºæ–°é¡¹ç›®

    - **title**: é¡¹ç›®æ ‡é¢˜ (å¿…å¡«, 1-255å­—ç¬¦)
    - **description**: é¡¹ç›®æè¿° (å¯é€‰, æœ€å¤š1000å­—ç¬¦)
    - **canvas_width**: ç”»å¸ƒå®½åº¦ (é»˜è®¤1080, èŒƒå›´100-10000)
    - **canvas_height**: ç”»å¸ƒé«˜åº¦ (é»˜è®¤1080, èŒƒå›´100-10000)

    è¿”å›åˆ›å»ºçš„é¡¹ç›®è¯¦æƒ…,åŒ…æ‹¬è‡ªåŠ¨ç”Ÿæˆçš„ ID å’Œæ—¶é—´æˆ³ã€‚
    """
    # å®ç°é€»è¾‘...
    pass
```

**å¯¼å‡º OpenAPI è§„èŒƒ**:

```bash
# è®¿é—®è‡ªåŠ¨ç”Ÿæˆçš„ OpenAPI JSON
curl http://localhost:3002/api/v1/openapi.json > openapi.json

# æˆ–é€šè¿‡ Swagger UI æ‰‹åŠ¨ä¸‹è½½
# è®¿é—® http://localhost:3002/api/v1/docs
# ç‚¹å‡» "Download" æŒ‰é’®
```

**åŒæ­¥åˆ°å‰ç«¯**:

```bash
# ä½¿ç”¨ openapi-typescript è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰
cd frontend
npm run generate:types  # ä»åç«¯ OpenAPI ç«¯ç‚¹ç”Ÿæˆç±»å‹
```

---

### API ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

#### ç‰ˆæœ¬å‘½åè§„èŒƒ

- **ç‰ˆæœ¬æ ¼å¼**: `v1`, `v2`, `v3` (ä¸ä½¿ç”¨ `v1.1`, `v1.2`)
- **ç‰ˆæœ¬æ§åˆ¶æ–¹å¼**: URL è·¯å¾„ (`/api/v1/users`, `/api/v2/users`)
- **ä¸æ¨è**: Header ç‰ˆæœ¬æ§åˆ¶ (`Accept: application/vnd.api+json; version=1`)

#### ç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸ

| é˜¶æ®µ | æ—¶é—´çº¿ | è¡ŒåŠ¨ |
|------|--------|------|
| **v2 å‘å¸ƒ** | Day 0 | æ–°ç‰ˆæœ¬æ­£å¼å‘å¸ƒ |
| **v1 ç»´æŠ¤æœŸ** | Day 0 - Day 180 | v1 ä»ç„¶å¯ç”¨,ä¿®å¤å…³é”® Bug |
| **v1 åºŸå¼ƒé€šçŸ¥** | Day 90 | æå‰ 3 ä¸ªæœˆé€šçŸ¥å®¢æˆ·ç«¯å‡çº§ |
| **v1 åœç”¨** | Day 180 | v1 å®Œå…¨åœç”¨,å¼ºåˆ¶å‡çº§åˆ° v2 |

#### å‘åå…¼å®¹åŸåˆ™

**å…è®¸çš„å˜æ›´ (ä¸ç ´åå…¼å®¹æ€§)**:
- âœ… æ·»åŠ æ–°å­—æ®µåˆ°å“åº” (å‰ç«¯å¿½ç•¥æœªçŸ¥å­—æ®µ)
- âœ… æ·»åŠ æ–°ç«¯ç‚¹ (ä¸å½±å“ç°æœ‰ç«¯ç‚¹)
- âœ… æ”¾å®½éªŒè¯è§„åˆ™ (ä¾‹å¦‚: å¿…å¡« â†’ å¯é€‰)
- âœ… æ·»åŠ æ–°çš„æšä¸¾å€¼ (å¦‚æœå‰ç«¯èƒ½ä¼˜é›…é™çº§)

**ç¦æ­¢çš„å˜æ›´ (ç ´åå…¼å®¹æ€§,å¿…é¡»å‘å¸ƒæ–°ç‰ˆæœ¬)**:
- âŒ åˆ é™¤æˆ–é‡å‘½åç°æœ‰å­—æ®µ
- âŒ æ›´æ”¹å­—æ®µæ•°æ®ç±»å‹ (string â†’ integer)
- âŒ æ›´æ”¹ç°æœ‰ç«¯ç‚¹çš„è¡Œä¸º
- âŒ æ”¶ç´§éªŒè¯è§„åˆ™ (å¯é€‰ â†’ å¿…å¡«)
- âŒ åˆ é™¤æšä¸¾å€¼

#### åºŸå¼ƒ API æ ‡è®°

**é€šè¿‡å“åº”å¤´æ ‡è®°å³å°†åºŸå¼ƒçš„ API**:

```python
# backend/app/api/v1/endpoints/projects.py (V1 å³å°†åºŸå¼ƒ)
from fastapi import Response

@app.get("/api/v1/projects/{project_id}")
async def get_project_v1(project_id: UUID, response: Response):
    """
    è·å–é¡¹ç›®è¯¦æƒ… (V1 - å³å°†åºŸå¼ƒ)

    âš ï¸ æ­¤ç«¯ç‚¹å°†äº 2026-04-26 åºŸå¼ƒ,è¯·è¿ç§»åˆ° /api/v2/projects/{project_id}
    """
    # æ·»åŠ åºŸå¼ƒè­¦å‘Šå¤´
    response.headers["Deprecation"] = "true"
    response.headers["Sunset"] = "Sat, 26 Apr 2026 00:00:00 GMT"
    response.headers["Link"] = '</api/v2/projects/{project_id}>; rel="successor-version"'

    # è¿”å›æ•°æ®...
    return project
```

**å‰ç«¯æ£€æµ‹åºŸå¼ƒè­¦å‘Š**:

```typescript
// frontend/src/services/api/axiosInstance.ts
axiosInstance.interceptors.response.use(
  response => {
    // æ£€æµ‹åºŸå¼ƒè­¦å‘Š
    if (response.headers['deprecation'] === 'true') {
      const sunsetDate = response.headers['sunset']
      const successorLink = response.headers['link']

      console.warn(
        `âš ï¸ API å³å°†åºŸå¼ƒ: ${response.config.url}\n` +
        `åºŸå¼ƒæ—¥æœŸ: ${sunsetDate}\n` +
        `æ›¿ä»£ç«¯ç‚¹: ${successorLink}`
      )

      // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
      analytics.track('api_deprecation_warning', {
        endpoint: response.config.url,
        sunsetDate,
        successorLink
      })
    }

    return response.data
  }
)
```

---

## Mock Server æ­å»º

### Mock Server çš„ä½œç”¨

**æ ¸å¿ƒä»·å€¼**:
1. âœ… **å‰åç«¯å¹¶è¡Œå¼€å‘**: å‰ç«¯ä¸ä¾èµ–åç«¯å®ç°,åŸºäº Mock æ•°æ®å¿«é€Ÿå¼€å‘
2. âœ… **å¿«é€ŸåŸå‹éªŒè¯**: éªŒè¯ API è®¾è®¡æ˜¯å¦åˆç†,æå‰å‘ç°é—®é¢˜
3. âœ… **é›†æˆæµ‹è¯•**: å‰ç«¯æµ‹è¯•æ—¶ä½¿ç”¨ç¨³å®šçš„ Mock æ•°æ®
4. âœ… **ç¦»çº¿å¼€å‘**: ä¸ä¾èµ–ç½‘ç»œå’Œåç«¯æœåŠ¡,æœ¬åœ°å³å¯å¼€å‘

### Mock Server æŠ€æœ¯é€‰å‹

#### æ–¹æ¡ˆ 1: Prism (æ¨è)

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨åŸºäº OpenAPI è§„èŒƒ,è‡ªåŠ¨ç”Ÿæˆ Mock æ•°æ®
- âœ… æ”¯æŒ OpenAPI 3.0/3.1,è‡ªåŠ¨éªŒè¯è¯·æ±‚/å“åº”
- âœ… æ”¯æŒåŠ¨æ€å“åº” (åŸºäºè¯·æ±‚å‚æ•°è¿”å›ä¸åŒæ•°æ®)
- âœ… æ”¯æŒè¯·æ±‚éªŒè¯ (æ ¡éªŒè¯·æ±‚æ˜¯å¦ç¬¦åˆ Schema)

**å®‰è£…å’Œä½¿ç”¨**:

```bash
# å…¨å±€å®‰è£… Prism
npm install -g @stoplight/prism-cli

# å¯åŠ¨ Mock Server
prism mock api-specs/openapi.yaml --port 4010

# è¾“å‡º:
# [10:00:00] â€º [CLI] â€¦  awaiting  Starting Prismâ€¦
# [10:00:01] â€º [CLI] âœ”  success   Prism is listening on http://127.0.0.1:4010
```

**é«˜çº§é…ç½®**:

```bash
# å¯ç”¨è¯·æ±‚éªŒè¯ (æ ¡éªŒè¯·æ±‚æ˜¯å¦ç¬¦åˆ OpenAPI è§„èŒƒ)
prism mock api-specs/openapi.yaml --port 4010 --validate-request

# å¯ç”¨å“åº”éªŒè¯ (æ ¡éªŒå“åº”æ˜¯å¦ç¬¦åˆ Schema)
prism mock api-specs/openapi.yaml --port 4010 --validate-response

# å¯ç”¨åŠ¨æ€å“åº” (åŸºäºè¯·æ±‚å‚æ•°è¿”å›ä¸åŒæ•°æ®)
prism mock api-specs/openapi.yaml --port 4010 --dynamic
```

#### æ–¹æ¡ˆ 2: json-server (ç®€å•åœºæ™¯)

**ä¼˜åŠ¿**:
- âœ… è½»é‡çº§,å¿«é€Ÿæ­å»º
- âœ… æ”¯æŒå®Œæ•´çš„ REST API (CRUD)
- âœ… æ”¯æŒå…³ç³»æ•°æ® (é€šè¿‡ ID å…³è”)

**ç¼ºç‚¹**:
- âŒ ä¸æ”¯æŒ OpenAPI è§„èŒƒ
- âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ Mock æ•°æ®

**å®‰è£…å’Œä½¿ç”¨**:

```bash
# å®‰è£… json-server
npm install -g json-server

# åˆ›å»º Mock æ•°æ®æ–‡ä»¶
cat > db.json <<EOF
{
  "users": [
    { "id": "user_123", "email": "user@example.com", "username": "testuser" }
  ],
  "projects": [
    { "id": "proj_123", "user_id": "user_123", "title": "åŒ11å¤§ä¿ƒ" }
  ]
}
EOF

# å¯åŠ¨ Mock Server
json-server --watch db.json --port 4010
```

#### æ–¹æ¡ˆ 3: MSW (Mock Service Worker) - å‰ç«¯é›†æˆæ–¹æ¡ˆ

**ä¼˜åŠ¿**:
- âœ… æµè§ˆå™¨æ‹¦æˆªè¯·æ±‚,ä¸éœ€è¦é¢å¤–æœåŠ¡
- âœ… æ”¯æŒè¯·æ±‚åŒ¹é…ã€åŠ¨æ€å“åº”ã€é”™è¯¯æ¨¡æ‹Ÿ
- âœ… ä¸å‰ç«¯ä»£ç é›†æˆ,æ–¹ä¾¿è°ƒè¯•

**ç¼ºç‚¹**:
- âŒ ä»…é€‚ç”¨äºå‰ç«¯å¼€å‘,ä¸é€‚ç”¨äºåç«¯æµ‹è¯•
- âŒ éœ€è¦æ‰‹åŠ¨ç¼–å†™ Mock é€»è¾‘

**å®‰è£…å’Œé…ç½®**:

```bash
# å®‰è£… MSW
npm install msw --save-dev

# åˆå§‹åŒ– Service Worker
npx msw init public/ --save
```

**å®šä¹‰ Mock Handlers**:

```typescript
// src/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  // ç”¨æˆ·æ³¨å†Œ
  http.post('/api/v1/auth/register', async ({ request }) => {
    const body = await request.json()
    return HttpResponse.json({
      id: crypto.randomUUID(),
      email: body.email,
      username: body.username,
      created_at: new Date().toISOString()
    }, { status: 201 })
  }),

  // ç”¨æˆ·ç™»å½•
  http.post('/api/v1/auth/login', async ({ request }) => {
    const body = await request.json()
    return HttpResponse.json({
      access_token: 'mock_jwt_token_' + Date.now(),
      refresh_token: 'mock_refresh_token_' + Date.now(),
      expires_in: 86400
    })
  }),

  // è·å–é¡¹ç›®åˆ—è¡¨
  http.get('/api/v1/projects', ({ request }) => {
    const url = new URL(request.url)
    const page = Number(url.searchParams.get('page') || '1')
    const limit = Number(url.searchParams.get('limit') || '20')

    return HttpResponse.json({
      total: 100,
      page,
      limit,
      data: [
        {
          id: 'proj_1',
          title: 'åŒ11å¤§ä¿ƒæµ·æŠ¥',
          thumbnail_url: 'https://via.placeholder.com/300x300',
          status: 'draft',
          created_at: '2025-10-26T10:00:00Z'
        },
        {
          id: 'proj_2',
          title: 'æ–°å“å‘å¸ƒæµ·æŠ¥',
          thumbnail_url: 'https://via.placeholder.com/300x300',
          status: 'published',
          created_at: '2025-10-25T15:30:00Z'
        }
      ]
    })
  }),

  // åˆ›å»ºé¡¹ç›®
  http.post('/api/v1/projects', async ({ request }) => {
    const body = await request.json()
    return HttpResponse.json({
      id: crypto.randomUUID(),
      ...body,
      user_id: 'user_123',
      thumbnail_url: null,
      status: 'draft',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }, { status: 201 })
  }),

  // æ¨¡æ‹Ÿé”™è¯¯å“åº”
  http.post('/api/v1/designs/generate', async ({ request }) => {
    // æ¨¡æ‹Ÿ 50% çš„å¤±è´¥ç‡ç”¨äºæµ‹è¯•é”™è¯¯å¤„ç†
    if (Math.random() > 0.5) {
      return HttpResponse.json({
        error: 'internal_server_error',
        message: 'AI æ¨¡å‹æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
        code: 'AI_SERVICE_UNAVAILABLE'
      }, { status: 500 })
    }

    return HttpResponse.json({
      task_id: 'task_' + crypto.randomUUID(),
      status: 'processing'
    }, { status: 202 })
  })
]
```

**å¯åŠ¨ Mock Worker**:

```typescript
// src/mocks/browser.ts
import { setupWorker } from 'msw/browser'
import { handlers } from './handlers'

export const worker = setupWorker(...handlers)

// src/main.ts
import { worker } from './mocks/browser'

if (import.meta.env.DEV && import.meta.env.VITE_USE_MOCK === 'true') {
  worker.start({
    onUnhandledRequest: 'warn'  // è­¦å‘ŠæœªåŒ¹é…çš„è¯·æ±‚
  })
}
```

---

### Prism Mock Server æ­å»ºæ­¥éª¤ (æ¨èæ–¹æ¡ˆ)

#### Step 1: å®‰è£… Prism

```bash
npm install -g @stoplight/prism-cli
```

#### Step 2: å¯åŠ¨ Mock Server

```bash
# åŸºæœ¬å¯åŠ¨
prism mock api-specs/openapi.yaml --port 4010

# å¯ç”¨è¯·æ±‚éªŒè¯å’ŒåŠ¨æ€å“åº”
prism mock api-specs/openapi.yaml --port 4010 --validate-request --dynamic
```

#### Step 3: å‰ç«¯é…ç½®ä»£ç†

**Vite é…ç½®** (`vite.config.ts`):

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: process.env.VITE_USE_MOCK === 'true'
          ? 'http://localhost:4010'   // Mock Server
          : 'http://localhost:8080',  // çœŸå®åç«¯ (Kong API Gateway)
        changeOrigin: true,
        rewrite: (path) => path  // ä¸é‡å†™è·¯å¾„
      }
    }
  }
})
```

#### Step 4: ç¯å¢ƒå˜é‡æ§åˆ¶

```bash
# .env.development (æœ¬åœ°å¼€å‘,ä½¿ç”¨ Mock)
VITE_USE_MOCK=true
VITE_API_BASE_URL=http://localhost:5173  # Vite ä»£ç†ä¼šè½¬å‘åˆ° Mock Server

# .env.staging (è”è°ƒç¯å¢ƒ,ä½¿ç”¨çœŸå®åç«¯)
VITE_USE_MOCK=false
VITE_API_BASE_URL=https://api-staging.example.com

# .env.production (ç”Ÿäº§ç¯å¢ƒ)
VITE_USE_MOCK=false
VITE_API_BASE_URL=https://api.example.com
```

#### Step 5: Mock æ•°æ®å®šåˆ¶

Prism è‡ªåŠ¨æ ¹æ® OpenAPI Schema ç”Ÿæˆéšæœºæ•°æ®,ä½†å¯ä»¥é€šè¿‡ `x-examples` å®šä¹‰è‡ªå®šä¹‰ç¤ºä¾‹:

```yaml
# components/schemas/User.yaml
UserResponse:
  type: object
  properties:
    id:
      type: string
      format: uuid
    email:
      type: string
      format: email
    username:
      type: string
  x-examples:
    example-1:
      summary: æ™®é€šç”¨æˆ·
      value:
        id: "123e4567-e89b-12d3-a456-426614174000"
        email: "user@example.com"
        username: "testuser"
    example-2:
      summary: VIP ç”¨æˆ·
      value:
        id: "987e6543-e21c-12d3-a456-426614174000"
        email: "vip@example.com"
        username: "vipuser"
```

**ä½¿ç”¨ç‰¹å®šç¤ºä¾‹**:

```bash
# é€šè¿‡ Prefer å¤´æŒ‡å®šä½¿ç”¨å“ªä¸ªç¤ºä¾‹
curl -H "Prefer: example=example-1" http://localhost:4010/api/v1/users/123
```

---

### Mock æ•°æ®ç®¡ç†è§„èŒƒ

#### çœŸå®æ€§åŸåˆ™

Mock æ•°æ®åº”å°½é‡æ¥è¿‘çœŸå®æ•°æ®:

- âœ… **åˆç†çš„ç”¨æˆ·å**: `"alice_wang"`, `"bob_chen"` (è€Œé `"user1"`, `"test"`)
- âœ… **çœŸå®çš„é‚®ç®±**: `"alice@example.com"` (ç¬¦åˆé‚®ç®±æ ¼å¼)
- âœ… **åˆç†çš„æ—¥æœŸ**: `"2025-10-26T10:30:00Z"` (ISO 8601 æ ¼å¼)
- âœ… **çœŸå®çš„ URL**: `"https://cdn.example.com/images/proj_123.jpg"`

#### å¤šæ ·æ€§åŸåˆ™

åŒ…å«æ­£å¸¸ã€è¾¹ç•Œã€å¼‚å¸¸æƒ…å†µçš„ Mock æ•°æ®:

```typescript
// src/mocks/handlers.ts - å¤šæ ·æ€§ Mock æ•°æ®
http.get('/api/v1/projects', () => {
  return HttpResponse.json({
    data: [
      // æ­£å¸¸é¡¹ç›®
      { id: 'proj_1', title: 'åŒ11å¤§ä¿ƒæµ·æŠ¥', status: 'published' },

      // è‰ç¨¿é¡¹ç›®
      { id: 'proj_2', title: 'æ–°å“å‘å¸ƒ', status: 'draft' },

      // å½’æ¡£é¡¹ç›®
      { id: 'proj_3', title: 'æ˜¥èŠ‚æ´»åŠ¨', status: 'archived' },

      // è¶…é•¿æ ‡é¢˜ (è¾¹ç•Œæƒ…å†µ)
      { id: 'proj_4', title: 'è¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸é•¿çš„é¡¹ç›®æ ‡é¢˜,ç”¨äºæµ‹è¯•å‰ç«¯UIåœ¨æ ‡é¢˜è¿‡é•¿æ—¶çš„æ˜¾ç¤ºæ•ˆæœ', status: 'draft' },

      // ç©ºæè¿°
      { id: 'proj_5', title: 'ç®€å•æµ·æŠ¥', description: null, status: 'draft' },

      // æ— ç¼©ç•¥å›¾
      { id: 'proj_6', title: 'æ— é¢„è§ˆå›¾', thumbnail_url: null, status: 'draft' }
    ]
  })
})
```

#### ä¸€è‡´æ€§åŸåˆ™

Mock æ•°æ®ç»“æ„å¿…é¡»ä¸ OpenAPI Schema ä¸€è‡´:

```typescript
// âŒ é”™è¯¯: å­—æ®µåä¸ä¸€è‡´
{
  projectId: 'proj_123',  // åº”è¯¥æ˜¯ id
  name: 'é¡¹ç›®åç§°'        // åº”è¯¥æ˜¯ title
}

// âœ… æ­£ç¡®: ä¸¥æ ¼æŒ‰ç…§ Schema å®šä¹‰
{
  id: 'proj_123',
  title: 'é¡¹ç›®åç§°',
  created_at: '2025-10-26T10:00:00Z'
}
```

#### åŠ¨æ€æ€§åŸåˆ™

æ”¯æŒ CRUD æ“ä½œ,çŠ¶æ€å¯ä»¥å˜åŒ–:

```typescript
// src/mocks/handlers.ts - åŠ¨æ€ Mock æ•°æ®
let projects = [
  { id: 'proj_1', title: 'åŒ11å¤§ä¿ƒ', status: 'draft' },
  { id: 'proj_2', title: 'æ–°å“å‘å¸ƒ', status: 'published' }
]

// GET - è¯»å–
http.get('/api/v1/projects', () => {
  return HttpResponse.json({ data: projects })
})

// POST - åˆ›å»º
http.post('/api/v1/projects', async ({ request }) => {
  const body = await request.json()
  const newProject = {
    id: crypto.randomUUID(),
    ...body,
    status: 'draft',
    created_at: new Date().toISOString()
  }
  projects.push(newProject)
  return HttpResponse.json(newProject, { status: 201 })
})

// PUT - æ›´æ–°
http.put('/api/v1/projects/:id', async ({ params, request }) => {
  const body = await request.json()
  const index = projects.findIndex(p => p.id === params.id)
  if (index === -1) {
    return HttpResponse.json({ error: 'Project not found' }, { status: 404 })
  }
  projects[index] = { ...projects[index], ...body }
  return HttpResponse.json(projects[index])
})

// DELETE - åˆ é™¤
http.delete('/api/v1/projects/:id', ({ params }) => {
  projects = projects.filter(p => p.id !== params.id)
  return new HttpResponse(null, { status: 204 })
})
```

---

## æ•°æ®æ¨¡å‹åŒæ­¥æœºåˆ¶

### æ•°æ®åº“ Schema ç‰ˆæœ¬ç®¡ç† (Alembic)

#### å®‰è£… Alembic

```bash
cd backend/services/user-service
poetry add alembic
alembic init alembic
```

#### é…ç½® Alembic

```python
# alembic/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context

# å¯¼å…¥æ‰€æœ‰ SQLAlchemy æ¨¡å‹
from app.models.base import Base  # SQLAlchemy Base
from app.models import User, Project, Design, Export, Asset  # æ‰€æœ‰æ¨¡å‹

# é…ç½® Alembic ä½¿ç”¨ Base.metadata
target_metadata = Base.metadata

def run_migrations_online():
    """è¿è¡Œåœ¨çº¿è¿ç§»"""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()

run_migrations_online()
```

```ini
# alembic.ini
[alembic]
script_location = alembic
sqlalchemy.url = postgresql+asyncpg://user:password@localhost:5432/pgen_dev

[loggers]
keys = root,sqlalchemy,alembic

[logger_alembic]
level = INFO
handlers =
qualname = alembic
```

#### åˆ›å»ºè¿ç§»è„šæœ¬

**è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬**:

```bash
# è‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜æ›´å¹¶ç”Ÿæˆè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "Create users table"

# è¾“å‡º:
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.autogenerate.compare] Detected added table 'users'
# INFO  [alembic.autogenerate.compare] Detected added index 'idx_users_email' on '['email']'
# Generating /path/to/alembic/versions/001_create_users_table.py ...  done
```

**æ‰‹åŠ¨åˆ›å»ºè¿ç§»è„šæœ¬**:

```bash
# åˆ›å»ºç©ºè¿ç§»è„šæœ¬,æ‰‹åŠ¨ç¼–å†™ SQL
alembic revision -m "Add avatar_url to users"
```

#### è¿ç§»è„šæœ¬ç¤ºä¾‹

```python
# alembic/versions/001_create_users_table.py
"""Create users table

Revision ID: 001
Revises:
Create Date: 2025-10-26 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic
revision = '001'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    """å‡çº§åˆ°æ­¤ç‰ˆæœ¬"""
    # åˆ›å»º users è¡¨
    op.create_table(
        'users',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('email', sa.String(255), unique=True, nullable=False),
        sa.Column('username', sa.String(100), nullable=False),
        sa.Column('password_hash', sa.String(255), nullable=False),
        sa.Column('avatar_url', sa.Text, nullable=True),
        sa.Column('subscription_tier', sa.String(20), server_default='free'),
        sa.Column('created_at', sa.TIMESTAMP, server_default=sa.func.now()),
        sa.Column('updated_at', sa.TIMESTAMP, onupdate=sa.func.now()),
        sa.Column('deleted_at', sa.TIMESTAMP, nullable=True)
    )

    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_users_email', 'users', ['email'])
    op.create_index('idx_users_username', 'users', ['username'])
    op.create_index('idx_users_created_at', 'users', ['created_at'])

def downgrade():
    """å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"""
    op.drop_index('idx_users_created_at')
    op.drop_index('idx_users_username')
    op.drop_index('idx_users_email')
    op.drop_table('users')
```

#### æ‰§è¡Œè¿ç§»

```bash
# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# æŸ¥çœ‹è¿ç§»å†å²
alembic history

# å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
alembic upgrade head

# å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬
alembic upgrade 001

# å›é€€ä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# å›é€€åˆ°æŒ‡å®šç‰ˆæœ¬
alembic downgrade 001

# æŸ¥çœ‹å³å°†æ‰§è¡Œçš„ SQL (ä¸å®é™…æ‰§è¡Œ)
alembic upgrade head --sql
```

#### ç‰ˆæœ¬ç®¡ç†è§„èŒƒ

**è¿ç§»è„šæœ¬å‘½åè§„èŒƒ**:

```
001_create_users_table.py
002_create_projects_table.py
003_add_avatar_url_to_users.py
004_add_indexes_to_projects.py
```

**è¿ç§»è„šæœ¬ç¼–å†™è§„èŒƒ**:

- âœ… æ¯ä¸ªç”¨æˆ·æ•…äº‹å®Œæˆååˆ›å»ºä¸€ä¸ªè¿ç§»è„šæœ¬
- âœ… è¿ç§»è„šæœ¬å¿…é¡»å¯å›é€€ (å®ç° `downgrade` æ–¹æ³•)
- âœ… ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰å¿…é¡»åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- âœ… è¿ç§»è„šæœ¬å¿…é¡»é€šè¿‡ä»£ç å®¡æŸ¥
- âœ… é¿å…æ•°æ®ä¸¢å¤± (åˆ é™¤åˆ—å‰å…ˆå¤‡ä»½æ•°æ®)
- âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§

---

### å‰ç«¯ TypeScript ç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆ

#### æ–¹æ¡ˆ 1: ä» OpenAPI ç”Ÿæˆ (æ¨è)

**å®‰è£…å·¥å…·**:

```bash
npm install -D openapi-typescript
```

**ç”Ÿæˆ TypeScript ç±»å‹**:

```bash
# ä»æœ¬åœ° OpenAPI æ–‡ä»¶ç”Ÿæˆ
npx openapi-typescript api-specs/openapi.yaml -o src/types/api.d.ts

# ä»åç«¯ API ç«¯ç‚¹ç”Ÿæˆ (åç«¯éœ€æš´éœ² OpenAPI JSON)
npx openapi-typescript http://localhost:3002/api/v1/openapi.json -o src/types/api.d.ts
```

**ä½¿ç”¨ç”Ÿæˆçš„ç±»å‹**:

```typescript
// src/types/api.d.ts (è‡ªåŠ¨ç”Ÿæˆ)
export interface components {
  schemas: {
    UserResponse: {
      id: string
      email: string
      username: string
      avatar_url?: string
      created_at: string
    }
    UserCreate: {
      email: string
      password: string
      username: string
    }
    ProjectResponse: {
      id: string
      user_id: string
      title: string
      description?: string
      canvas_width: number
      canvas_height: number
      thumbnail_url?: string
      status: 'draft' | 'published' | 'archived'
      created_at: string
      updated_at: string
    }
    ProjectCreate: {
      title: string
      description?: string
      canvas_width?: number
      canvas_height?: number
    }
  }
}

// src/services/userService.ts
import type { components } from '@/types/api'

type UserResponse = components['schemas']['UserResponse']
type UserCreate = components['schemas']['UserCreate']

export async function createUser(data: UserCreate): Promise<UserResponse> {
  const response = await axios.post<UserResponse>('/api/v1/users', data)
  return response.data
}

export async function getUser(userId: string): Promise<UserResponse> {
  const response = await axios.get<UserResponse>(`/api/v1/users/${userId}`)
  return response.data
}
```

**é…ç½®è‡ªåŠ¨ç”Ÿæˆè„šæœ¬**:

```json
// package.json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "generate:types": "openapi-typescript http://localhost:3002/api/v1/openapi.json -o src/types/api.d.ts",
    "generate:types:local": "openapi-typescript ../backend/api-specs/openapi.yaml -o src/types/api.d.ts"
  }
}
```

**è‡ªåŠ¨åŒ–æµç¨‹**:

```bash
# åç«¯å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (æš´éœ² OpenAPI JSON)
cd backend/services/user-service
poetry run uvicorn app.main:app --reload --port 3002

# å‰ç«¯ç”Ÿæˆ TypeScript ç±»å‹
cd frontend
npm run generate:types

# Git pre-commit hook æ£€æŸ¥ç±»å‹æ˜¯å¦æœ€æ–°
# .git/hooks/pre-commit
#!/bin/bash
npm run generate:types
git add src/types/api.d.ts
```

---

### æ•°æ®éªŒè¯è§„åˆ™åŒæ­¥ (Pydantic â†” Zod)

#### åç«¯ Pydantic æ¨¡å‹

```python
# backend/app/schemas/user.py
from pydantic import BaseModel, EmailStr, constr, Field

class UserCreate(BaseModel):
    """ç”¨æˆ·æ³¨å†Œè¯·æ±‚æ¨¡å‹"""
    email: EmailStr = Field(..., description="é‚®ç®±åœ°å€")
    password: constr(min_length=8, max_length=100) = Field(..., description="å¯†ç  (8-100å­—ç¬¦)")
    username: constr(min_length=3, max_length=50) = Field(..., description="ç”¨æˆ·å (3-50å­—ç¬¦)")

    class Config:
        json_schema_extra = {
            "example": {
                "email": "user@example.com",
                "password": "SecurePassword123",
                "username": "alice_wang"
            }
        }
```

#### å‰ç«¯ Zod éªŒè¯ (æ‰‹åŠ¨åŒæ­¥)

```typescript
// src/schemas/user.ts
import { z } from 'zod'

export const userCreateSchema = z.object({
  email: z.string().email('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  password: z.string()
    .min(8, 'å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦')
    .max(100, 'å¯†ç æœ€å¤š 100 ä¸ªå­—ç¬¦'),
  username: z.string()
    .min(3, 'ç”¨æˆ·åè‡³å°‘ 3 ä¸ªå­—ç¬¦')
    .max(50, 'ç”¨æˆ·åæœ€å¤š 50 ä¸ªå­—ç¬¦')
})

export type UserCreate = z.infer<typeof userCreateSchema>
```

#### è¡¨å•éªŒè¯é›†æˆ

**æ–¹æ¡ˆ 1: ä½¿ç”¨ vee-validate + zod**:

```vue
<script setup lang="ts">
import { useForm } from 'vee-validate'
import { toTypedSchema } from '@vee-validate/zod'
import { userCreateSchema } from '@/schemas/user'
import { createUser } from '@/services/userService'

const { handleSubmit, errors, defineField } = useForm({
  validationSchema: toTypedSchema(userCreateSchema)
})

const [email] = defineField('email')
const [password] = defineField('password')
const [username] = defineField('username')

const onSubmit = handleSubmit(async (values) => {
  try {
    await createUser(values)
    // æ³¨å†ŒæˆåŠŸ,è·³è½¬åˆ°ç™»å½•é¡µ
  } catch (error) {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  }
})
</script>

<template>
  <form @submit="onSubmit">
    <div>
      <label>é‚®ç®±</label>
      <input v-model="email" type="email" />
      <span class="error">{{ errors.email }}</span>
    </div>

    <div>
      <label>å¯†ç </label>
      <input v-model="password" type="password" />
      <span class="error">{{ errors.password }}</span>
    </div>

    <div>
      <label>ç”¨æˆ·å</label>
      <input v-model="username" type="text" />
      <span class="error">{{ errors.username }}</span>
    </div>

    <button type="submit">æ³¨å†Œ</button>
  </form>
</template>
```

**æ–¹æ¡ˆ 2: ä½¿ç”¨ Element Plus è¡¨å•éªŒè¯**:

```vue
<script setup lang="ts">
import { ref, reactive } from 'vue'
import type { FormInstance, FormRules } from 'element-plus'
import { createUser } from '@/services/userService'

const formRef = ref<FormInstance>()
const formData = reactive({
  email: '',
  password: '',
  username: ''
})

// éªŒè¯è§„åˆ™ (ä¸åç«¯ Pydantic ä¿æŒä¸€è‡´)
const rules = reactive<FormRules>({
  email: [
    { required: true, message: 'è¯·è¾“å…¥é‚®ç®±', trigger: 'blur' },
    { type: 'email', message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 8, max: 100, message: 'å¯†ç é•¿åº¦ä¸º 8-100 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' },
    { min: 3, max: 50, message: 'ç”¨æˆ·åé•¿åº¦ä¸º 3-50 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ]
})

const onSubmit = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (valid) {
      await createUser(formData)
    }
  })
}
</script>

<template>
  <el-form ref="formRef" :model="formData" :rules="rules">
    <el-form-item label="é‚®ç®±" prop="email">
      <el-input v-model="formData.email" />
    </el-form-item>

    <el-form-item label="å¯†ç " prop="password">
      <el-input v-model="formData.password" type="password" />
    </el-form-item>

    <el-form-item label="ç”¨æˆ·å" prop="username">
      <el-input v-model="formData.username" />
    </el-form-item>

    <el-form-item>
      <el-button type="primary" @click="onSubmit">æ³¨å†Œ</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### åŒæ­¥ç­–ç•¥

**ä¼˜å…ˆçº§**: åç«¯éªŒè¯ > å‰ç«¯éªŒè¯

- å‰ç«¯éªŒè¯ä»…ä¸º UX ä¼˜åŒ– (å³æ—¶åé¦ˆ)
- åç«¯éªŒè¯æ‰æ˜¯çœŸæ­£çš„å®‰å…¨å±éšœ
- å‰ç«¯éªŒè¯è§„åˆ™å¿…é¡»ä¸åç«¯ Pydantic æ¨¡å‹ä¿æŒä¸€è‡´
- å®šæœŸå®¡æŸ¥: æ¯ä¸ª Sprint ç»“æŸåæ£€æŸ¥å‰åç«¯éªŒè¯è§„åˆ™ä¸€è‡´æ€§

---

## å®æ—¶åä½œæœºåˆ¶

### WebSocket åè®®å®šä¹‰

#### è¿æ¥å»ºç«‹

```
ws://localhost:3000/ws/projects/{project_id}?token={jwt_token}
```

**è®¤è¯æµç¨‹**:
1. å®¢æˆ·ç«¯å‘èµ· WebSocket è¿æ¥,æºå¸¦ JWT Token (é€šè¿‡ Query String)
2. æœåŠ¡å™¨éªŒè¯ Token æœ‰æ•ˆæ€§
3. éªŒè¯é€šè¿‡,å»ºç«‹ WebSocket è¿æ¥
4. éªŒè¯å¤±è´¥,æ‹’ç»è¿æ¥ (è¿”å› 401)

#### æ¶ˆæ¯æ ¼å¼ (JSON)

**åŸºç¡€æ¶ˆæ¯ç»“æ„**:

```json
{
  "type": "event_type",
  "payload": {
    // å…·ä½“æ•°æ®
  },
  "timestamp": "2025-10-26T10:30:00Z",
  "user_id": "uuid"
}
```

#### æ¶ˆæ¯ç±»å‹å®šä¹‰

**1. project.update - é¡¹ç›®å…ƒæ•°æ®æ›´æ–°**

```json
{
  "type": "project.update",
  "payload": {
    "project_id": "proj_123",
    "field": "title",
    "value": "æ–°é¡¹ç›®åç§°",
    "updated_at": "2025-10-26T10:30:00Z"
  },
  "timestamp": "2025-10-26T10:30:00Z",
  "user_id": "user_123"
}
```

**2. design.change - è®¾è®¡å†…å®¹å˜æ›´**

```json
{
  "type": "design.change",
  "payload": {
    "design_id": "design_v1",
    "operation": "update",  // add | update | delete
    "element": {
      "id": "elem_123",
      "type": "text",
      "properties": {
        "content": "åŒ11å¤§ä¿ƒ",
        "fontSize": 48,
        "color": "#FF0000",
        "x": 100,
        "y": 200
      }
    }
  },
  "timestamp": "2025-10-26T10:30:00Z",
  "user_id": "user_123"
}
```

**3. export.complete - å¯¼å‡ºå®Œæˆé€šçŸ¥**

```json
{
  "type": "export.complete",
  "payload": {
    "export_id": "exp_456",
    "status": "success",  // success | failed
    "download_url": "https://s3.amazonaws.com/pgen-prod/exports/exp_456/design.png",
    "format": "png",
    "file_size": 1024000
  },
  "timestamp": "2025-10-26T10:35:00Z",
  "user_id": "user_123"
}
```

**4. user.join / user.leave - ç”¨æˆ·è¿›å…¥/ç¦»å¼€åä½œ**

```json
{
  "type": "user.join",
  "payload": {
    "user_id": "user_456",
    "username": "Alice",
    "avatar_url": "https://cdn.example.com/avatars/user_456.jpg"
  },
  "timestamp": "2025-10-26T10:30:00Z"
}
```

---

### åç«¯ WebSocket å®ç° (FastAPI)

#### å®‰è£…ä¾èµ–

```bash
poetry add websockets
```

#### WebSocket ç«¯ç‚¹

```python
# backend/app/api/v1/endpoints/websocket.py
from fastapi import WebSocket, WebSocketDisconnect, Depends, Query
from typing import Dict, List
from app.core.auth import get_current_user_from_token
from app.services.websocket_manager import manager

@app.websocket("/ws/projects/{project_id}")
async def websocket_endpoint(
    websocket: WebSocket,
    project_id: str,
    token: str = Query(...),
    db: AsyncSession = Depends(get_db)
):
    """
    é¡¹ç›®åä½œ WebSocket ç«¯ç‚¹

    - **project_id**: é¡¹ç›® ID
    - **token**: JWT Token (Query String)

    æ”¯æŒçš„æ¶ˆæ¯ç±»å‹:
    - project.update: é¡¹ç›®å…ƒæ•°æ®æ›´æ–°
    - design.change: è®¾è®¡å†…å®¹å˜æ›´
    - user.join: ç”¨æˆ·è¿›å…¥
    - user.leave: ç”¨æˆ·ç¦»å¼€
    """
    # éªŒè¯ Token
    try:
        current_user = await get_current_user_from_token(token, db)
    except Exception:
        await websocket.close(code=1008, reason="Unauthorized")
        return

    # å»ºç«‹è¿æ¥
    await manager.connect(websocket, project_id, current_user.id)

    try:
        while True:
            # æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
            data = await websocket.receive_json()

            # å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ· (æ’é™¤è‡ªå·±)
            await manager.broadcast(
                project_id,
                data,
                exclude_user_id=current_user.id
            )

    except WebSocketDisconnect:
        # ç”¨æˆ·æ–­å¼€è¿æ¥
        await manager.disconnect(websocket, project_id, current_user.id)
```

#### è¿æ¥ç®¡ç†å™¨

```python
# backend/app/services/websocket_manager.py
from typing import Dict, List
from fastapi import WebSocket
import json

class WebSocketManager:
    """WebSocket è¿æ¥ç®¡ç†å™¨"""

    def __init__(self):
        # æ´»è·ƒè¿æ¥: {project_id: [(websocket, user_id), ...]}
        self.active_connections: Dict[str, List[tuple[WebSocket, str]]] = {}

    async def connect(self, websocket: WebSocket, project_id: str, user_id: str):
        """å»ºç«‹ WebSocket è¿æ¥"""
        await websocket.accept()

        if project_id not in self.active_connections:
            self.active_connections[project_id] = []

        self.active_connections[project_id].append((websocket, user_id))

        # é€šçŸ¥å…¶ä»–ç”¨æˆ·æœ‰æ–°ç”¨æˆ·åŠ å…¥
        await self.broadcast(
            project_id,
            {
                "type": "user.join",
                "payload": {"user_id": user_id},
                "timestamp": datetime.utcnow().isoformat()
            },
            exclude_user_id=user_id
        )

    async def disconnect(self, websocket: WebSocket, project_id: str, user_id: str):
        """æ–­å¼€ WebSocket è¿æ¥"""
        if project_id in self.active_connections:
            self.active_connections[project_id] = [
                (ws, uid) for ws, uid in self.active_connections[project_id]
                if ws != websocket
            ]

            # å¦‚æœé¡¹ç›®æ²¡æœ‰æ´»è·ƒè¿æ¥,åˆ é™¤è®°å½•
            if not self.active_connections[project_id]:
                del self.active_connections[project_id]

        # é€šçŸ¥å…¶ä»–ç”¨æˆ·æœ‰ç”¨æˆ·ç¦»å¼€
        await self.broadcast(
            project_id,
            {
                "type": "user.leave",
                "payload": {"user_id": user_id},
                "timestamp": datetime.utcnow().isoformat()
            }
        )

    async def broadcast(
        self,
        project_id: str,
        message: dict,
        exclude_user_id: str = None
    ):
        """å¹¿æ’­æ¶ˆæ¯åˆ°é¡¹ç›®çš„æ‰€æœ‰è¿æ¥"""
        if project_id not in self.active_connections:
            return

        for websocket, user_id in self.active_connections[project_id]:
            # æ’é™¤æŒ‡å®šç”¨æˆ· (é€šå¸¸æ˜¯å‘é€è€…æœ¬äºº)
            if exclude_user_id and user_id == exclude_user_id:
                continue

            try:
                await websocket.send_json(message)
            except Exception:
                # è¿æ¥å·²æ–­å¼€,ç§»é™¤
                await self.disconnect(websocket, project_id, user_id)

# å…¨å±€å•ä¾‹
manager = WebSocketManager()
```

---

### å‰ç«¯ WebSocket é›†æˆ (Vue 3 Composable)

#### WebSocket Composable

```typescript
// src/composables/useWebSocket.ts
import { ref, onMounted, onUnmounted } from 'vue'
import { useAuthStore } from '@/stores/auth'

export function useWebSocket(projectId: string) {
  const ws = ref<WebSocket | null>(null)
  const isConnected = ref(false)
  const authStore = useAuthStore()

  const connect = () => {
    const token = authStore.token
    const wsUrl = `ws://localhost:3000/ws/projects/${projectId}?token=${token}`

    ws.value = new WebSocket(wsUrl)

    ws.value.onopen = () => {
      isConnected.value = true
      console.log('[WebSocket] Connected to project:', projectId)
    }

    ws.value.onclose = () => {
      isConnected.value = false
      console.log('[WebSocket] Disconnected from project:', projectId)

      // è‡ªåŠ¨é‡è¿ (3ç§’å)
      setTimeout(() => {
        console.log('[WebSocket] Reconnecting...')
        connect()
      }, 3000)
    }

    ws.value.onerror = (error) => {
      console.error('[WebSocket] Error:', error)
    }
  }

  const send = (message: any) => {
    if (ws.value && isConnected.value) {
      ws.value.send(JSON.stringify(message))
    } else {
      console.warn('[WebSocket] Cannot send message, not connected')
    }
  }

  const on = (callback: (data: any) => void) => {
    if (ws.value) {
      ws.value.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data)
          callback(data)
        } catch (error) {
          console.error('[WebSocket] Failed to parse message:', error)
        }
      }
    }
  }

  const close = () => {
    if (ws.value) {
      ws.value.close()
      ws.value = null
    }
  }

  onMounted(() => {
    connect()
  })

  onUnmounted(() => {
    close()
  })

  return {
    isConnected,
    send,
    on,
    close
  }
}
```

#### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<script setup lang="ts">
import { useWebSocket } from '@/composables/useWebSocket'
import { useProjectStore } from '@/stores/project'
import { useDesignStore } from '@/stores/design'

const props = defineProps<{ projectId: string }>()

const projectStore = useProjectStore()
const designStore = useDesignStore()
const { isConnected, send, on } = useWebSocket(props.projectId)

// ç›‘å¬ WebSocket æ¶ˆæ¯
on((message) => {
  console.log('[WebSocket] Received:', message)

  switch (message.type) {
    case 'design.change':
      // æ›´æ–°è®¾è®¡å†…å®¹
      designStore.updateElement(message.payload.element)
      break

    case 'export.complete':
      // æ˜¾ç¤ºå¯¼å‡ºå®Œæˆé€šçŸ¥
      projectStore.setExportStatus(message.payload)
      ElNotification({
        title: 'å¯¼å‡ºå®Œæˆ',
        message: 'æ‚¨çš„è®¾è®¡å·²æˆåŠŸå¯¼å‡º',
        type: 'success'
      })
      break

    case 'user.join':
      // æ˜¾ç¤ºç”¨æˆ·åŠ å…¥æç¤º
      projectStore.addCollaborator(message.payload)
      ElMessage.info(`${message.payload.username} åŠ å…¥äº†åä½œ`)
      break

    case 'user.leave':
      // æ˜¾ç¤ºç”¨æˆ·ç¦»å¼€æç¤º
      projectStore.removeCollaborator(message.payload.user_id)
      break
  }
})

// å‘é€è®¾è®¡å˜æ›´æ¶ˆæ¯
function handleDesignChange(element: any) {
  send({
    type: 'design.change',
    payload: {
      design_id: props.projectId,
      operation: 'update',
      element
    },
    timestamp: new Date().toISOString()
  })
}
</script>

<template>
  <div>
    <div v-if="!isConnected" class="warning">
      âš ï¸ å®æ—¶åä½œå·²æ–­å¼€,æ­£åœ¨é‡è¿...
    </div>

    <!-- ç¼–è¾‘å™¨ç»„ä»¶ -->
    <DesignEditor @element-change="handleDesignChange" />
  </div>
</template>
```

---

### å‰ç«¯çŠ¶æ€åŒæ­¥ç­–ç•¥

#### ä¹è§‚æ›´æ–° (Optimistic Updates)

**æµç¨‹**:
1. ç”¨æˆ·æ“ä½œ â†’ ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ (Pinia Store)
2. åŒæ—¶å‘é€ WebSocket æ¶ˆæ¯é€šçŸ¥å…¶ä»–ç”¨æˆ·
3. ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ â†’ æˆåŠŸåˆ™ä¿æŒ,å¤±è´¥åˆ™å›æ»š

**ç¤ºä¾‹**:

```typescript
// src/stores/design.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { api } from '@/services/api'
import { useWebSocket } from '@/composables/useWebSocket'

export const useDesignStore = defineStore('design', () => {
  const elements = ref<Element[]>([])

  async function updateElement(elementId: string, updates: Partial<Element>) {
    // 1. æ‰¾åˆ°è¦æ›´æ–°çš„å…ƒç´ 
    const index = elements.value.findIndex(el => el.id === elementId)
    if (index === -1) return

    // 2. ä¿å­˜æ—§å€¼ (ç”¨äºå›æ»š)
    const oldElement = { ...elements.value[index] }

    // 3. ä¹è§‚æ›´æ–°æœ¬åœ°çŠ¶æ€
    elements.value[index] = {
      ...elements.value[index],
      ...updates
    }

    try {
      // 4. å‘é€åˆ°æœåŠ¡å™¨
      await api.updateElement(elementId, updates)

      // 5. é€šè¿‡ WebSocket é€šçŸ¥å…¶ä»–ç”¨æˆ·
      websocket.send({
        type: 'design.change',
        payload: {
          element_id: elementId,
          operation: 'update',
          element: elements.value[index]
        }
      })

    } catch (error) {
      // 6. å¤±è´¥åˆ™å›æ»šåˆ°æ—§å€¼
      elements.value[index] = oldElement

      console.error('[Design Store] Update failed, rolled back:', error)
      ElMessage.error('æ›´æ–°å¤±è´¥,å·²æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€')
    }
  }

  return { elements, updateElement }
})
```

#### å†²çªè§£å†³ç­–ç•¥

**MVP é˜¶æ®µç­–ç•¥**: Last Write Wins (LWW) + å†²çªæç¤º

**å®ç°**:

```typescript
// src/stores/design.ts
export const useDesignStore = defineStore('design', () => {
  const elements = ref<Element[]>([])
  const lastModifiedTime = ref<Record<string, number>>({})

  async function updateElement(elementId: string, updates: Partial<Element>) {
    const index = elements.value.findIndex(el => el.id === elementId)
    if (index === -1) return

    const oldElement = { ...elements.value[index] }
    const currentTime = Date.now()

    // æ£€æµ‹å†²çª
    if (lastModifiedTime.value[elementId] &&
        currentTime - lastModifiedTime.value[elementId] < 2000) {
      // 2ç§’å†…æœ‰å…¶ä»–ç”¨æˆ·ä¿®æ”¹,æç¤ºå†²çª
      const confirmed = await ElMessageBox.confirm(
        'å…¶ä»–ç”¨æˆ·ä¹Ÿåœ¨ç¼–è¾‘æ­¤å…ƒç´ ,æ˜¯å¦è¦†ç›–?',
        'å†²çªæç¤º',
        {
          confirmButtonText: 'è¦†ç›–',
          cancelButtonText: 'æ”¾å¼ƒ',
          type: 'warning'
        }
      ).catch(() => false)

      if (!confirmed) {
        return  // ç”¨æˆ·é€‰æ‹©æ”¾å¼ƒ
      }
    }

    // ä¹è§‚æ›´æ–°
    elements.value[index] = { ...elements.value[index], ...updates }
    lastModifiedTime.value[elementId] = currentTime

    try {
      await api.updateElement(elementId, updates)

      websocket.send({
        type: 'design.change',
        payload: {
          element_id: elementId,
          operation: 'update',
          element: elements.value[index]
        }
      })
    } catch (error) {
      elements.value[index] = oldElement
      ElMessage.error('æ›´æ–°å¤±è´¥')
    }
  }

  return { elements, updateElement }
})
```

---

### å¿ƒè·³å’Œé‡è¿æœºåˆ¶

#### åç«¯å¿ƒè·³

```python
# backend/app/services/websocket_manager.py
import asyncio

async def send_heartbeat(websocket: WebSocket):
    """æ¯ 30 ç§’å‘é€å¿ƒè·³"""
    while True:
        await asyncio.sleep(30)
        try:
            await websocket.send_json({"type": "ping"})
        except Exception:
            # è¿æ¥å·²æ–­å¼€
            break
```

#### å‰ç«¯å¿ƒè·³å“åº”

```typescript
// src/composables/useWebSocket.ts
on((message) => {
  if (message.type === 'ping') {
    // å“åº”å¿ƒè·³
    send({ type: 'pong' })
  }
})
```

#### è‡ªåŠ¨é‡è¿

```typescript
// src/composables/useWebSocket.ts
const reconnect = () => {
  console.log('[WebSocket] Reconnecting...')

  // æŒ‡æ•°é€€é¿é‡è¿ (1ç§’, 2ç§’, 4ç§’, 8ç§’, æœ€å¤š16ç§’)
  const delay = Math.min(1000 * Math.pow(2, reconnectAttempts.value), 16000)
  reconnectAttempts.value++

  setTimeout(() => {
    connect()
  }, delay)
}

ws.value.onclose = () => {
  isConnected.value = false

  // è‡ªåŠ¨é‡è¿
  if (reconnectAttempts.value < 10) {
    reconnect()
  } else {
    ElMessage.error('WebSocket è¿æ¥å¤±è´¥,è¯·åˆ·æ–°é¡µé¢é‡è¯•')
  }
}
```

---

## å‰åç«¯å¹¶è¡Œå¼€å‘æœ€ä½³å®è·µ

### å¼€å‘æµç¨‹å›¾

```mermaid
flowchart TD
    A[äº§å“éœ€æ±‚ PRD] --> B[åç«¯è®¾è®¡ API å¥‘çº¦]
    B --> C[å‰ç«¯è¯„å®¡ API å¥‘çº¦]
    C --> D{å¥‘çº¦ç¡®è®¤?}
    D -->|éœ€ä¿®æ”¹| B
    D -->|ç¡®è®¤| E[åç«¯å¼€å‘ API]
    D -->|ç¡®è®¤| F[å‰ç«¯å¯åŠ¨ Mock Server]

    F --> G[å‰ç«¯å¼€å‘ UI]
    E --> H[åç«¯å®Œæˆ]
    G --> I[å‰ç«¯å®Œæˆ]

    H --> J[è”è°ƒæµ‹è¯•]
    I --> J

    J --> K{æµ‹è¯•é€šè¿‡?}
    K -->|å¤±è´¥| L[ä¿®å¤é—®é¢˜]
    L --> J
    K -->|é€šè¿‡| M[éƒ¨ç½²å‘å¸ƒ]
```

### æ¯æ—¥ç«™ä¼šæ£€æŸ¥æ¸…å•

```yaml
API å¥‘çº¦æ£€æŸ¥:
  - [ ] API å¥‘çº¦æ˜¯å¦æœ‰å˜æ›´ (éœ€è¦åŒæ­¥å‰ç«¯)
  - [ ] OpenAPI è§„èŒƒæ˜¯å¦å·²æ›´æ–°
  - [ ] TypeScript ç±»å‹æ˜¯å¦å·²é‡æ–°ç”Ÿæˆ

Mock Server æ£€æŸ¥:
  - [ ] Mock Server æ˜¯å¦æ­£å¸¸è¿è¡Œ
  - [ ] Mock æ•°æ®æ˜¯å¦ä¸ OpenAPI å¥‘çº¦ä¸€è‡´
  - [ ] å‰ç«¯æ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨ Mock API

å‰ç«¯å¼€å‘è¿›åº¦:
  - [ ] å‰ç«¯æ˜¯å¦é‡åˆ° API è®¾è®¡é—®é¢˜
  - [ ] UI å®ç°æ˜¯å¦ç¬¦åˆè®¾è®¡ç¨¿
  - [ ] æ˜¯å¦éœ€è¦æ–°çš„ API ç«¯ç‚¹

åç«¯å¼€å‘è¿›åº¦:
  - [ ] åç«¯æ˜¯å¦é‡åˆ°æ•°æ®æ¨¡å‹è®¾è®¡é—®é¢˜
  - [ ] API å®ç°æ˜¯å¦ç¬¦åˆå¥‘çº¦
  - [ ] å•å…ƒæµ‹è¯•æ˜¯å¦é€šè¿‡

å®æ—¶åä½œ:
  - [ ] WebSocket æ¶ˆæ¯æ ¼å¼æ˜¯å¦éœ€è¦è°ƒæ•´
  - [ ] æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ (å»¶è¿Ÿã€æ‰çº¿)

é˜»å¡é—®é¢˜:
  - [ ] æœ‰æ— é˜»å¡é—®é¢˜éœ€è¦åè°ƒ
  - [ ] æ˜¯å¦éœ€è¦è°ƒæ•´ä¼˜å…ˆçº§
```

### è”è°ƒæµ‹è¯•æµç¨‹

#### Step 1: å‰ç«¯åˆ‡æ¢åˆ°çœŸå®åç«¯

```bash
# ä¿®æ”¹ç¯å¢ƒå˜é‡
# .env.development
VITE_USE_MOCK=false
VITE_API_BASE_URL=http://localhost:8080  # Kong API Gateway

# é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨
pnpm dev
```

#### Step 2: è¿è¡Œé›†æˆæµ‹è¯•

```bash
# åç«¯å¯åŠ¨æ‰€æœ‰æœåŠ¡
cd backend
docker-compose up -d

# å‰ç«¯å¯åŠ¨å¼€å‘æœåŠ¡å™¨
cd frontend
pnpm dev

# è¿è¡Œ E2E æµ‹è¯•
pnpm test:e2e
```

#### Step 3: é—®é¢˜å®šä½

**ä½¿ç”¨æµè§ˆå™¨ DevTools æŸ¥çœ‹ç½‘ç»œè¯·æ±‚**:

1. æ‰“å¼€ Chrome DevTools (F12)
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. è¿‡æ»¤ XHR/Fetch è¯·æ±‚
4. æ£€æŸ¥è¯·æ±‚/å“åº”æ˜¯å¦ç¬¦åˆå¥‘çº¦

**æ£€æŸ¥ API å“åº”æ˜¯å¦ç¬¦åˆå¥‘çº¦**:

```typescript
// ä½¿ç”¨ TypeScript ç±»å‹æ£€æŸ¥
import type { components } from '@/types/api'

type ProjectResponse = components['schemas']['ProjectResponse']

const project: ProjectResponse = await getProject('proj_123')

// å¦‚æœå“åº”ä¸ç¬¦åˆ Schema,TypeScript ä¼šæŠ¥é”™
console.log(project.id)           // âœ… æ­£ç¡®
console.log(project.projectId)    // âŒ TypeScript é”™è¯¯: 'projectId' ä¸å­˜åœ¨
```

**æ£€æŸ¥å‰ç«¯ç±»å‹å®šä¹‰æ˜¯å¦ä¸ API ä¸€è‡´**:

```bash
# é‡æ–°ç”Ÿæˆ TypeScript ç±»å‹
npm run generate:types

# æ£€æŸ¥æ˜¯å¦æœ‰ç±»å‹é”™è¯¯
npm run type-check

# å¦‚æœæœ‰ç±»å‹é”™è¯¯,è¯´æ˜ API å¥‘çº¦å·²å˜æ›´
# éœ€è¦åŒæ­¥æ›´æ–°å‰ç«¯ä»£ç 
```

#### Step 4: é—®é¢˜ä¿®å¤

**API å¥‘çº¦é—®é¢˜ â†’ æ›´æ–° OpenAPI è§„èŒƒ â†’ é‡æ–°ç”Ÿæˆå‰ç«¯ç±»å‹**:

```bash
# åç«¯ä¿®æ”¹ OpenAPI è§„èŒƒ
cd backend/api-specs
# ç¼–è¾‘ openapi.yaml

# æäº¤ Pull Request å®¡æŸ¥å¥‘çº¦å˜æ›´
git add api-specs/openapi.yaml
git commit -m "chore: update API spec - add export_format field"
git push origin feature/api-spec-update

# å‰ç«¯é‡æ–°ç”Ÿæˆç±»å‹
cd frontend
npm run generate:types
```

**ä¸šåŠ¡é€»è¾‘é—®é¢˜ â†’ ä¿®å¤ä»£ç  â†’ é‡æ–°æµ‹è¯•**:

```bash
# åç«¯ä¿®å¤
cd backend/services/user-service
# ä¿®æ”¹ä»£ç 
poetry run pytest tests/  # è¿è¡Œæµ‹è¯•

# å‰ç«¯ä¿®å¤
cd frontend
# ä¿®æ”¹ä»£ç 
pnpm test:unit  # è¿è¡Œå•å…ƒæµ‹è¯•
pnpm test:e2e   # è¿è¡Œ E2E æµ‹è¯•
```

**æ€§èƒ½é—®é¢˜ â†’ ä¼˜åŒ–æŸ¥è¯¢/ç¼“å­˜ â†’ å‹åŠ›æµ‹è¯•**:

```bash
# åç«¯æ€§èƒ½ä¼˜åŒ–
# 1. æ·»åŠ æ•°æ®åº“ç´¢å¼•
# 2. å¯ç”¨ Redis ç¼“å­˜
# 3. ä¼˜åŒ– SQL æŸ¥è¯¢

# è¿è¡Œå‹åŠ›æµ‹è¯•
cd backend
poetry run locust -f tests/load/locustfile.py --host=http://localhost:8080
```

---

### ä»£ç å®¡æŸ¥æ¸…å•

#### å‰ç«¯ä»£ç å®¡æŸ¥

```yaml
TypeScript ç±»å‹:
  - [ ] æ—  any ç±»å‹ (ä½¿ç”¨ç”Ÿæˆçš„ API ç±»å‹)
  - [ ] æ­£ç¡®ä½¿ç”¨ components['schemas']['XXX']
  - [ ] Props å’Œ Emits æœ‰æ˜ç¡®ç±»å‹å®šä¹‰

API è°ƒç”¨:
  - [ ] ä½¿ç”¨ç”Ÿæˆçš„ç±»å‹å®šä¹‰
  - [ ] é”™è¯¯å¤„ç†å®Œå–„ (ç½‘ç»œé”™è¯¯ã€ä¸šåŠ¡é”™è¯¯)
  - [ ] åŠ è½½çŠ¶æ€å¤„ç† (loadingã€errorã€empty)

çŠ¶æ€ç®¡ç†:
  - [ ] Pinia Store ä½¿ç”¨è§„èŒƒ (Setup Store è¯­æ³•)
  - [ ] ä¸ç›´æ¥ä¿®æ”¹ state (é€šè¿‡ action)
  - [ ] å¼‚æ­¥æ“ä½œä½¿ç”¨ async/await

é€»è¾‘å¤ç”¨:
  - [ ] Composable é€»è¾‘å¤ç”¨ (ä¸é‡å¤ä»£ç )
  - [ ] å•ä¸€èŒè´£åŸåˆ™ (ä¸€ä¸ª Composable åªåšä¸€ä»¶äº‹)

æ€§èƒ½ä¼˜åŒ–:
  - [ ] å¤§åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
  - [ ] å›¾ç‰‡æ‡’åŠ è½½
  - [ ] è·¯ç”±æ‡’åŠ è½½
```

#### åç«¯ä»£ç å®¡æŸ¥

```yaml
Pydantic æ¨¡å‹:
  - [ ] å®šä¹‰å®Œæ•´ (æœ‰éªŒè¯è§„åˆ™)
  - [ ] æœ‰ç¤ºä¾‹æ•°æ® (json_schema_extra)
  - [ ] å­—æ®µæœ‰æè¿° (description)

API å“åº”:
  - [ ] ç¬¦åˆ OpenAPI è§„èŒƒ
  - [ ] ä½¿ç”¨ response_model æŒ‡å®šè¿”å›ç±»å‹
  - [ ] çŠ¶æ€ç æ­£ç¡® (200/201/204/400/401/403/404/500)

å¼‚æ­¥æ“ä½œ:
  - [ ] ä½¿ç”¨ async/await
  - [ ] æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ asyncpg
  - [ ] Redis æ“ä½œä½¿ç”¨ aioredis

æ•°æ®åº“æŸ¥è¯¢:
  - [ ] ä½¿ç”¨ SQLAlchemy ORM (ä¸ç›´æ¥å†™ SQL)
  - [ ] æœ‰ç´¢å¼•ä¼˜åŒ– (æŸ¥è¯¢é¢‘ç¹çš„å­—æ®µ)
  - [ ] é¿å… N+1 æŸ¥è¯¢ (ä½¿ç”¨ joinedload/selectinload)

è®¤è¯/æˆæƒ:
  - [ ] å—ä¿æŠ¤ç«¯ç‚¹ä½¿ç”¨ Depends(get_current_user)
  - [ ] æ£€æŸ¥ç”¨æˆ·æƒé™ (æ‰€æœ‰è€…æ£€æŸ¥ã€è§’è‰²æ£€æŸ¥)
  - [ ] JWT Token éªŒè¯å®Œå–„

é”™è¯¯å¤„ç†:
  - [ ] ä½¿ç”¨ HTTPException æŠ›å‡ºé”™è¯¯
  - [ ] é”™è¯¯æ¶ˆæ¯æ¸…æ™° (å‰ç«¯å¯ç›´æ¥å±•ç¤º)
  - [ ] æ—¥å¿—è®°å½•å®Œå–„ (ERROR/WARNING/INFO)
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº† AI PosterGen é¡¹ç›®å‰åç«¯ååŒå¼€å‘çš„å®Œæ•´è§„èŒƒ,åŒ…æ‹¬:

âœ… **API å¥‘çº¦å¼€å‘æµç¨‹** - å¥‘çº¦ä¼˜å…ˆã€OpenAPI è§„èŒƒã€ç‰ˆæœ¬ç®¡ç†
âœ… **Mock Server æ­å»º** - Prism/MSW ï¿½ï¿½æ¡ˆã€Mock æ•°æ®ç®¡ç†
âœ… **æ•°æ®æ¨¡å‹åŒæ­¥æœºåˆ¶** - Alembic è¿ç§»ã€TypeScript ç±»å‹ç”Ÿæˆã€Pydantic â†” Zod éªŒè¯
âœ… **å®æ—¶åä½œæœºåˆ¶** - WebSocket åè®®ã€å‰åç«¯é›†æˆã€ä¹è§‚æ›´æ–°ã€å†²çªè§£å†³
âœ… **å‰åç«¯å¹¶è¡Œå¼€å‘æœ€ä½³å®è·µ** - å¼€å‘æµç¨‹ã€è”è°ƒæµ‹è¯•ã€ä»£ç å®¡æŸ¥

**æ ¸å¿ƒåŸåˆ™**:
- å¥‘çº¦ä¼˜å…ˆ,å‰åç«¯å¹¶è¡Œå¼€å‘
- è‡ªåŠ¨åŒ–å·¥å…·é“¾,å‡å°‘æ‰‹åŠ¨åŒæ­¥
- ç±»å‹å®‰å…¨,ä» OpenAPI ç”Ÿæˆ TypeScript ç±»å‹
- å®æ—¶åä½œ,ä¹è§‚æ›´æ–° + å†²çªè§£å†³
- è§„èŒƒåŒ–æµç¨‹,ä»£ç å®¡æŸ¥æ¸…å•

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. æ­å»º OpenAPI è§„èŒƒå’Œ Mock Server
2. é…ç½®å‰ç«¯ç±»å‹è‡ªåŠ¨ç”Ÿæˆ
3. å¯åŠ¨ç¬¬ä¸€ä¸ª Sprint,æŒ‰ç…§æœ¬è§„èŒƒæ‰§è¡Œ
4. æ¯å‘¨ Retrospective,ä¼˜åŒ–ååŒæµç¨‹

---

**æ–‡æ¡£ç»´æŠ¤**:
- ç‰ˆæœ¬: V1.0
- åˆ›å»º: 2025å¹´10æœˆ26æ—¥
- æ›´æ–°é¢‘ç‡: æ¯æœˆæˆ–é‡å¤§å˜æ›´æ—¶
- ç»´æŠ¤äºº: æŠ€æœ¯ä¸»ç®¡/å‰ç«¯ Leader/åç«¯ Leader
